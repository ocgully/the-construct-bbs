---
phase: 01-terminal-foundation
plan: 05
type: execute
wave: 3
depends_on: ["01-03", "01-04"]
files_modified:
  - backend/src/main.rs
  - backend/src/services/welcome_art.rs
  - frontend/vite.config.ts
autonomous: false

must_haves:
  truths:
    - "Browser terminal displays ANSI art with correct CP437 box-drawing characters and CGA colors"
    - "User can type in browser terminal and see response from backend service"
    - "Terminal displays 80x24 grid with no scrollback and paginated output works"
    - "CRT effects are visible and toggleable in browser"
    - "Mobile browser displays terminal scaled to phone width with all 80 columns"
    - "Service can be entered and exited through the terminal"
  artifacts:
    - path: "backend/src/services/welcome_art.rs"
      provides: "ANSI art welcome screen with CP437 box-drawing and CGA colors"
      contains: "welcome_art"
    - path: "frontend/vite.config.ts"
      provides: "Vite configuration with WebSocket proxy to backend"
      contains: "proxy"
  key_links:
    - from: "frontend/src/websocket.ts"
      to: "backend/src/websocket/mod.rs"
      via: "WebSocket connection from browser to axum /ws endpoint"
      pattern: "ws://.*:3000/ws"
    - from: "backend/src/websocket/session.rs"
      to: "frontend/src/terminal.ts"
      via: "ANSI escape sequences sent over WebSocket rendered by xterm.js"
      pattern: "Message::Text"
    - from: "backend/src/services/welcome_art.rs"
      to: "backend/src/terminal/ansi.rs"
      via: "Welcome art uses AnsiWriter + cp437_to_utf8 for rendering"
      pattern: "AnsiWriter"
---

<objective>
Wire frontend and backend together for end-to-end operation. Serve frontend from the backend, create ANSI art welcome screen that tests CP437 rendering, verify full round-trip I/O, and confirm mobile + CRT effects work in the integrated system.

Purpose: This is the integration and verification plan. All the pieces (xterm.js terminal, WebSocket client, axum server, session management, ANSI writer, service registry) come together here. The ANSI art welcome screen is the acid test: if CP437 box-drawing renders correctly with CGA colors in the browser, the terminal foundation works.

Output: Fully integrated BBS terminal accessible at http://localhost:3000 with working ANSI art, service interaction, and visual verification.
</objective>

<execution_context>
@C:\Users\chris\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\chris\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-terminal-foundation/01-RESEARCH.md
@.planning/phases/01-terminal-foundation/01-CONTEXT.md

@.planning/phases/01-terminal-foundation/01-01-SUMMARY.md
@.planning/phases/01-terminal-foundation/01-02-SUMMARY.md
@.planning/phases/01-terminal-foundation/01-03-SUMMARY.md
@.planning/phases/01-terminal-foundation/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ANSI art welcome screen and serve frontend from backend</name>
  <files>
    backend/src/main.rs
    backend/src/services/welcome_art.rs
    frontend/vite.config.ts
  </files>
  <action>
1. Create `frontend/vite.config.ts` for development proxy:
   ```typescript
   import { defineConfig } from 'vite';
   export default defineConfig({
     server: {
       proxy: {
         '/ws': {
           target: 'ws://127.0.0.1:3000',
           ws: true,
         },
       },
     },
     build: {
       outDir: 'dist',
     },
   });
   ```

2. Configure axum to serve frontend static files in production:
   - In `backend/src/main.rs`, add tower-http ServeDir for serving frontend/dist/:
     ```rust
     use tower_http::services::ServeDir;
     // After other routes:
     .fallback_service(ServeDir::new("../frontend/dist"))
     ```
   - This means: `cargo run` from backend/ serves the built frontend at the root
   - For development: use `npm run dev` (Vite) with proxy to backend for WebSocket

3. Create `backend/src/services/welcome_art.rs`:
   - This module generates the ANSI art welcome screen that the session displays on connect
   - Use AnsiWriter and cp437_to_utf8 to build authentic BBS welcome art

   **The welcome screen should include (all rendered with AnsiWriter):**

   a) A box-drawn border using CP437 box-drawing characters:
      - Top-left: 0xDA (corner), Top-right: 0xBF (corner)
      - Bottom-left: 0xC0 (corner), Bottom-right: 0xD9 (corner)
      - Horizontal: 0xC4 (single line), Vertical: 0xB3 (single line)
      - Double-line variants for emphasis: 0xC9, 0xBB, 0xC8, 0xBC, 0xCD, 0xBA
      - Convert these CP437 bytes to UTF-8 using cp437_to_utf8()

   b) "THE CONSTRUCT" title in large text (use simple block letters with # or block characters)
      - Bright white on black background
      - Centered within the 80-column width

   c) A decorative divider line using CP437 extended characters

   d) "Terminal Foundation v0.1" subtitle in bright cyan

   e) System info lines in light gray:
      - "80x24 Terminal | CP437 Encoding | CGA Palette"

   f) Color test row: display all 16 CGA colors with labels, e.g.:
      - Show colored blocks or "##" in each of the 16 colors
      - This verifies the CGA palette is correct in the browser

   g) Box-drawing test: a small box (4x3) using single-line CP437 box characters
      - This verifies CP437 font rendering

   h) Below the art, show the service menu (from registry) and input prompt

   - Export function: `pub fn render_welcome(services: &[(String, String)]) -> String`
     - Takes list of (name, description) from registry
     - Returns complete ANSI string ready to send to terminal
   - Wrap entire output in synchronized rendering (DECSET 2026 begin/end)

4. Update Session (in session.rs or main.rs) to use welcome_art::render_welcome() instead of the simple welcome message from Plan 04.

5. Build the frontend for production serving:
   - Run `cd frontend && npm run build` to generate dist/
   - Verify backend can serve these files

6. Create a simple test script or document the manual test procedure:
   - Start backend: `cd backend && cargo run`
   - Open browser to http://127.0.0.1:3000
   - Welcome ANSI art should display with:
     - Correct box-drawing characters (no broken glyphs, no ?)
     - 16 CGA colors visible and correct (brown at index 6, not dark yellow)
     - Title centered and styled
   - Type service number to enter example service
   - Type 'quit' to exit service
   - Type 'quit' at main prompt to disconnect
  </action>
  <verify>
Build frontend: `cd frontend && npm run build` succeeds.
Build backend: `cd backend && cargo build` succeeds.
Start backend: `cd backend && cargo run` -- server starts.
Open http://127.0.0.1:3000 in browser:
  - ANSI art welcome screen renders with box-drawing characters
  - All 16 CGA colors display correctly
  - Title "THE CONSTRUCT" is visible and styled
  - Service menu lists available services
Type service number -- enter example service, interact, exit.
Type 'quit' -- connection closes cleanly.
  </verify>
  <done>
Frontend served from backend at http://localhost:3000. ANSI art welcome screen renders with correct CP437 box-drawing and CGA colors. Full round-trip I/O works: user types in browser, backend responds with ANSI output. Integration is complete and ready for visual verification.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual and functional verification of terminal foundation</name>
  <what-built>
Complete terminal foundation: xterm.js browser terminal connected via WebSocket to Rust backend, displaying ANSI art with CP437 characters, CGA 16-color palette, CRT effects, mobile responsive layout, and pluggable service architecture.
  </what-built>
  <how-to-verify>
**Desktop verification (http://localhost:3000):**
1. Open browser to http://127.0.0.1:3000
2. Verify ANSI art welcome screen:
   - Box-drawing characters render as connected lines (not as ? or broken glyphs)
   - All 16 colors are visible and look like authentic CGA (brown, not dark yellow at position 6)
   - Title "THE CONSTRUCT" is visible and properly styled
3. Verify terminal dimensions: 80 columns, 24 rows, no scrollback
4. Verify CRT effects: toggle between FULL, SUBTLE, CLEAN using keyboard shortcut
5. Verify dark bezel: terminal is framed by dark void, not decorative housing
6. Verify interactivity: type service number to enter example service, interact, type 'quit' to exit
7. Verify cursor: blinking block cursor visible

**Mobile verification (use phone or browser dev tools mobile emulation):**
8. Open same URL on phone (or enable mobile emulation in dev tools)
9. Verify all 80 columns visible (scaled down but complete)
10. Verify portrait orientation works
11. Verify tapping terminal brings up keyboard
12. Verify CRT effects work on mobile

**Architecture verification:**
13. Modify config.toml: set example service enabled = false
14. Restart backend
15. Verify example service no longer appears in menu
16. Set it back to enabled = true, restart, verify it reappears

Report any issues -- especially broken box-drawing characters, wrong colors, or mobile rendering problems.
  </how-to-verify>
  <resume-signal>Type "approved" if terminal foundation works correctly, or describe specific issues that need fixing.</resume-signal>
</task>

</tasks>

<verification>
1. Frontend builds with Vite (`npm run build` succeeds)
2. Backend serves frontend at http://localhost:3000
3. WebSocket connects from browser to backend
4. ANSI art renders with correct CP437 box-drawing characters
5. All 16 CGA colors display correctly
6. User can interact with services through the terminal
7. CRT effects are visible and toggleable
8. Mobile layout shows all 80 columns scaled to fit
9. Service toggle via config.toml works without code changes
10. Human visual verification confirms authentic BBS look and feel
</verification>

<success_criteria>
- End-to-end integration works: browser terminal communicates with backend via WebSocket
- ANSI art with CP437 box-drawing renders correctly (the acid test for Phase 1)
- CGA 16-color palette is accurate
- CRT effects are dial-able
- Mobile terminal is functional in portrait
- Service architecture is pluggable via config
- Human approves the visual and functional result
</success_criteria>

<output>
After completion, create `.planning/phases/01-terminal-foundation/01-05-SUMMARY.md`
</output>
