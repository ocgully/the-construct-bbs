---
phase: 01-terminal-foundation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/package.json
  - frontend/tsconfig.json
  - frontend/index.html
  - frontend/src/main.ts
  - frontend/src/terminal.ts
  - frontend/src/websocket.ts
  - frontend/src/crt-effects.ts
  - frontend/src/mobile.ts
  - frontend/styles/terminal.css
  - frontend/fonts/PerfectDOSVGA437.ttf
autonomous: true

must_haves:
  truths:
    - "xterm.js terminal renders in browser with 80x24 dimensions and CP437 font"
    - "CGA 16-color palette displays authentic DOS colors including brown (not dark yellow)"
    - "Terminal scales to fit mobile screen width in portrait orientation preserving all 80 columns"
    - "CRT effects are dial-able between clean, subtle, and full intensity levels"
    - "WebSocket client connects to backend and relays terminal I/O bidirectionally"
    - "Dark bezel surrounds terminal without decorative housing"
    - "No scrollback buffer -- terminal shows only current screen content"
  artifacts:
    - path: "frontend/src/terminal.ts"
      provides: "xterm.js initialization with WebGL, fit addon, web-fonts addon, CGA palette"
      contains: "Terminal"
    - path: "frontend/src/websocket.ts"
      provides: "WebSocket client with reconnection"
      contains: "WebSocket"
    - path: "frontend/src/crt-effects.ts"
      provides: "CRTFilter wrapper with clean/subtle/full levels"
      contains: "CRTLevel"
    - path: "frontend/src/mobile.ts"
      provides: "Mobile detection, portrait orientation, touch keyboard handling"
      contains: "isMobile"
    - path: "frontend/styles/terminal.css"
      provides: "Terminal container, bezel, full-viewport layout"
      contains: "terminal-container"
    - path: "frontend/fonts/PerfectDOSVGA437.ttf"
      provides: "Authentic CP437 TrueType font for box-drawing characters"
  key_links:
    - from: "frontend/src/main.ts"
      to: "frontend/src/terminal.ts"
      via: "initTerminal() call to set up xterm.js"
      pattern: "initTerminal"
    - from: "frontend/src/main.ts"
      to: "frontend/src/websocket.ts"
      via: "connectWebSocket() wires terminal I/O to server"
      pattern: "connectWebSocket"
    - from: "frontend/src/terminal.ts"
      to: "frontend/src/crt-effects.ts"
      via: "CRT effects applied to terminal canvas after initialization"
      pattern: "CRTController"
    - from: "frontend/src/terminal.ts"
      to: "@xterm/addon-web-fonts"
      via: "Font loaded and awaited before terminal opens"
      pattern: "webFontsAddon"
---

<objective>
Build the complete browser frontend -- xterm.js terminal with CP437 font and CGA palette, WebSocket client for server communication, dial-able CRT effects, mobile-responsive layout, and dark bezel styling.

Purpose: This is the user-facing terminal that renders all BBS content. It must display authentic DOS ANSI art with correct colors and characters, work on phones in portrait mode, and provide the atmospheric CRT effect that makes the experience feel like dialing into a real BBS.

Output: Frontend application ready to connect to the backend WebSocket server (built in Plan 04), displaying a properly styled 80x24 terminal with CRT effects.
</objective>

<execution_context>
@C:\Users\chris\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\chris\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-terminal-foundation/01-RESEARCH.md
@.planning/phases/01-terminal-foundation/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up frontend project with xterm.js terminal and CGA palette</name>
  <files>
    frontend/package.json
    frontend/tsconfig.json
    frontend/index.html
    frontend/src/main.ts
    frontend/src/terminal.ts
    frontend/styles/terminal.css
    frontend/fonts/PerfectDOSVGA437.ttf
  </files>
  <action>
1. Initialize npm project in `frontend/` directory:
   ```bash
   mkdir frontend && cd frontend && npm init -y
   ```

2. Install dependencies:
   ```bash
   npm install @xterm/xterm @xterm/addon-fit @xterm/addon-webgl @xterm/addon-web-fonts
   ```
   Also install a bundler -- use Vite for simplicity:
   ```bash
   npm install -D vite typescript
   ```

3. **Download Perfect DOS VGA 437 font:**
   - Download the .ttf file from https://github.com/CP437/PerfectDOSVGA437 (or the raw file URL)
   - Place it at `frontend/fonts/PerfectDOSVGA437.ttf`
   - If download fails, create a note and use a fallback approach: declare the font-face pointing to a CDN or use the repo's raw URL

4. Create `frontend/tsconfig.json`:
   - target: ES2020, module: ES2020, moduleResolution: bundler
   - strict: true
   - outDir: dist, rootDir: src

5. Create `frontend/styles/terminal.css`:
   - @font-face for PerfectDOSVGA437 pointing to ../fonts/PerfectDOSVGA437.ttf
   - `html, body` -- full viewport, margin 0, padding 0, background: #0a0a0a (near-black void), overflow: hidden
   - `.terminal-container` -- centered on screen, max-width constrained, dark bezel effect:
     - Use CSS box-shadow for subtle glow effect (dark blue/green tint, very subtle)
     - Border: 2-3px solid #1a1a1a (barely visible frame)
     - The bezel is "dark void around a glowing terminal" -- NOT a CRT monitor frame
     - Padding: small (4-8px) to create the minimal bezel gap
   - `.terminal-wrapper` -- contains xterm.js terminal element, position relative
   - On mobile (max-width: 768px or similar): terminal-container takes full width, minimal padding
   - Disable user-select on terminal container (prevent text selection interfering with terminal)

6. Create `frontend/src/terminal.ts`:
   - `export async function initTerminal(container: HTMLElement): Promise<Terminal>`
   - Create Terminal with:
     - cols: 80, rows: 24
     - fontFamily: "'Perfect DOS VGA 437', monospace"
     - fontSize: 16 (will be adjusted by fit addon on mobile)
     - scrollback: 0 (no scrollback -- authentic)
     - cursorBlink: true
     - cursorStyle: 'block'
     - theme with authentic CGA palette:
       ```
       black: '#000000', red: '#aa0000', green: '#00aa00',
       yellow: '#aa5500' (BROWN!), blue: '#0000aa', magenta: '#aa00aa',
       cyan: '#00aaaa', white: '#aaaaaa',
       brightBlack: '#555555', brightRed: '#ff5555', brightGreen: '#55ff55',
       brightYellow: '#ffff55', brightBlue: '#5555ff', brightMagenta: '#ff55ff',
       brightCyan: '#55ffff', brightWhite: '#ffffff',
       background: '#000000', foreground: '#aaaaaa',
       cursor: '#aaaaaa'
       ```
   - Load addons in correct order:
     1. WebFontsAddon -- load first, await ready() before proceeding
     2. FitAddon -- load after fonts
     3. WebglAddon -- load last (caches glyph metrics, needs correct font loaded first). Wrap in try-catch: if WebGL fails, log warning and continue with default renderer
   - Call term.open(container) AFTER font is ready
   - Call fitAddon.fit() after open
   - Set up debounced resize handler: `window.addEventListener('resize', debounce(() => fitAddon.fit(), 150))`
   - Return the Terminal instance
   - Export fitAddon reference for mobile.ts to use

   **Important:** The `yellow` theme color MUST be '#aa5500' (brown), not '#aaaa00'. This is the CGA brown that is one of the most common authentication issues for BBS art.

7. Create `frontend/src/main.ts`:
   - Import terminal.css
   - Import initTerminal, connectWebSocket (from Task 2)
   - On DOMContentLoaded:
     1. Get terminal container element
     2. Call `await initTerminal(container)`
     3. Call `connectWebSocket(terminal)` (will fail gracefully if server not running)
     4. Optionally initialize CRT effects (from Task 2 of this plan, or separate plan)
   - Show a "Connecting..." message on terminal if WebSocket not yet connected

8. Create `frontend/index.html`:
   - Minimal HTML: doctype, viewport meta tag, title "The Construct BBS"
   - Meta tags: charset utf-8, viewport width=device-width initial-scale=1 maximum-scale=1 user-scalable=no
   - Single div with id "terminal-container" and class "terminal-container"
   - Script tag pointing to src/main.ts (Vite handles TS compilation)
   - No other content -- the terminal IS the page

9. Add scripts to package.json:
   - "dev": "vite"
   - "build": "vite build"
   - "preview": "vite preview"
  </action>
  <verify>
Run `cd frontend && npm install && npm run dev` -- Vite dev server starts.
Open browser to Vite URL -- terminal container renders with dark bezel on black background.
xterm.js terminal appears with 80x24 grid, blinking cursor, CP437 font (or fallback monospace if font download failed).
No JavaScript errors in console.
Resize browser window -- terminal re-fits to container (but maintains 80 columns).
  </verify>
  <done>
xterm.js terminal renders in browser with CP437 font, CGA 16-color palette, 80x24 dimensions, no scrollback, dark bezel styling. Vite dev server works. Terminal re-fits on resize.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add WebSocket client, CRT effects, and mobile support</name>
  <files>
    frontend/src/websocket.ts
    frontend/src/crt-effects.ts
    frontend/src/mobile.ts
    frontend/src/main.ts
  </files>
  <action>
1. Create `frontend/src/websocket.ts`:
   - `export function connectWebSocket(terminal: Terminal): WebSocket`
   - Connect to `ws://${window.location.hostname}:3000/ws` (configurable via URL or environment)
   - On open: clear terminal, optionally write "Connected to The Construct" (will be replaced by server welcome in later phases)
   - On message: write message data directly to terminal (`terminal.write(event.data)`)
   - On close: write "Disconnected. Reconnecting..." to terminal, attempt reconnect with exponential backoff (1s, 2s, 4s, 8s, max 30s)
   - On error: log to console, don't crash
   - Wire terminal input to WebSocket: `terminal.onData((data) => { if (ws.readyState === WebSocket.OPEN) ws.send(data); })`
   - Return WebSocket instance for external control
   - Handle page unload: close WebSocket cleanly on `beforeunload`

2. Create `frontend/src/crt-effects.ts`:
   - Try to install and use CRTFilter package: `npm install crtfilter`
   - If CRTFilter is not available as npm package (it may only be on GitHub), implement a CSS-based fallback:
     - CSS approach: Apply scanline overlay using repeating-linear-gradient, subtle text-shadow for phosphor glow, and border-radius for slight curvature
     - This is acceptable for Phase 1; can upgrade to WebGL shader later if needed

   - Define `CRTLevel` enum: `CLEAN`, `SUBTLE`, `FULL`

   - `export class CRTController`:
     - Constructor takes the terminal container element
     - `setLevel(level: CRTLevel)` -- applies CSS classes or updates shader config:
       - CLEAN: no effects (remove all CRT classes/filters)
       - SUBTLE: light scanlines (opacity 0.15), subtle text glow, no curvature
       - FULL: visible scanlines (opacity 0.3), phosphor glow, slight curvature (1-2px border-radius on container), subtle flicker animation
     - `getLevel(): CRTLevel` -- returns current level
     - `cycle()` -- cycles through levels: FULL -> SUBTLE -> CLEAN -> FULL

   - CSS-based implementation details:
     - Scanlines: `::after` pseudo-element on terminal container with `background: repeating-linear-gradient(0deg, transparent, transparent 1px, rgba(0,0,0,0.3) 1px, rgba(0,0,0,0.3) 2px)` and `pointer-events: none`
     - Phosphor glow: `text-shadow` on the xterm viewport (may need to target `.xterm-screen`)
     - Curvature: very subtle `border-radius` on terminal container (2-4px)
     - Flicker: CSS animation with very subtle opacity variation (0.98-1.0)

   - Store CRT level preference in localStorage so it persists across sessions

3. Create `frontend/src/mobile.ts`:
   - `export function isMobile(): boolean` -- detect mobile via `navigator.maxTouchPoints > 0` and screen width
   - `export function setupMobile(terminal: Terminal, fitAddon: FitAddon)`:
     - If mobile detected:
       - Set viewport to prevent zoom: already handled by meta tag (user-scalable=no)
       - Force fit to screen width -- all 80 columns visible, font scales down proportionally
       - Handle virtual keyboard appearance: listen for `visualViewport.resize` event (modern API) to re-fit terminal when keyboard appears/disappears
       - On keyboard show: terminal may need to reduce visible rows while keeping 80 cols
       - Portrait is primary: ensure terminal is usable in portrait with keyboard visible
     - Handle orientation change: re-fit on `orientationchange` event
     - Ensure terminal input focuses on tap (mobile needs explicit focus for keyboard to appear):
       - Add tap/click handler on terminal container that calls `terminal.focus()`
       - xterm.js may handle this natively, but add as safety net
   - `export function setupMobileKeyboard(terminal: Terminal)`:
     - Create a hidden textarea overlay for mobile input if xterm.js native input is problematic
     - Only activate this if native xterm.js mobile input proves broken during testing
     - For now, rely on xterm.js native input handling and note this as a potential fix point

4. Update `frontend/src/main.ts` to wire everything together:
   - Import and call `setupMobile(terminal, fitAddon)` if `isMobile()`
   - Import and create `CRTController` with default level FULL
   - Add keyboard shortcut for CRT toggle: listen for specific key combo (e.g., Ctrl+Shift+C or F12) to cycle CRT levels
   - Note: Don't capture keys that conflict with terminal input. Use a key that wouldn't be typed in BBS context.
   - Write a small welcome message to terminal for testing: the BBS name in ANSI-style colors using xterm.js write() with escape sequences
  </action>
  <verify>
Run `cd frontend && npm run dev` -- Vite dev server starts without errors.
Open in desktop browser:
  - Terminal renders with CRT scanline effect visible (FULL mode default)
  - Press CRT toggle key -- effects cycle through FULL, SUBTLE, CLEAN
  - WebSocket connection attempts but fails gracefully (backend not running) with reconnect attempts
Open in mobile browser (or browser dev tools mobile emulation):
  - Terminal fits to phone screen width, all 80 columns visible
  - Portrait orientation works with keyboard
  - Tapping terminal area focuses input
No console errors in either desktop or mobile.
  </verify>
  <done>
WebSocket client connects to backend with auto-reconnect. CRT effects are dial-able (clean/subtle/full) and persist in localStorage. Mobile terminal scales to phone width in portrait, handles virtual keyboard appearance, and accepts touch input focus. Full frontend is ready for backend integration.
  </done>
</task>

</tasks>

<verification>
1. `npm run dev` starts Vite dev server successfully
2. Terminal renders at 80x24 with CP437 font and CGA palette in browser
3. Dark bezel surrounds terminal (dark void feel, not decorative)
4. CRT effects cycle between FULL, SUBTLE, and CLEAN
5. No scrollback buffer -- cannot scroll up
6. WebSocket client attempts connection and handles disconnection gracefully
7. Terminal input is captured and would be sent to WebSocket when connected
8. Mobile emulation shows terminal fitting to phone width with all 80 columns
9. Yellow theme color is brown (#aa5500), not dark yellow
10. No console errors
</verification>

<success_criteria>
- Browser displays authentic-looking BBS terminal with CP437 font and CGA colors
- CRT effects are toggleable at three levels
- Terminal is responsive on mobile in portrait orientation
- WebSocket client is ready for server connection
- Dark bezel creates "glowing terminal in void" aesthetic
- No scrollback, 80x24 fixed grid, blinking block cursor
</success_criteria>

<output>
After completion, create `.planning/phases/01-terminal-foundation/01-03-SUMMARY.md`
</output>
