---
phase: 04-time-limits-user-lists
plan: 05
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - backend/src/services/user_profile.rs
  - backend/src/services/mod.rs
  - backend/src/services/registry.rs
  - config.toml
autonomous: true

must_haves:
  truths:
    - "User can look up another user's profile by handle"
    - "Profile lookup shows same ANSI profile card as own profile (without edit options)"
    - "Who's Online, Last Callers, and Profile Lookup accessible from main menu"
    - "Menu items registered in config.toml"
  artifacts:
    - path: "backend/src/services/user_profile.rs"
      provides: "User profile lookup render function"
      contains: "render_user_lookup"
    - path: "config.toml"
      provides: "Main menu items for Who's Online, Last Callers, Profile Lookup"
      contains: "whos_online"
  key_links:
    - from: "backend/src/services/user_profile.rs"
      to: "backend/src/services/profile.rs"
      via: "reuses render_profile_card for displaying other users"
      pattern: "render_profile_card"
    - from: "config.toml"
      to: "backend/src/services/mod.rs"
      via: "service names referenced in menu config"
      pattern: "service_name"
---

<objective>
Create the user profile lookup service and register all Phase 4 services in the menu configuration.

Purpose: Users need to view other users' profiles (social feature), and all Phase 4 features need to be accessible from the menu system. This plan creates the profile lookup and wires all Phase 4 display features into the menu.
Output: user_profile.rs with lookup render, updated config.toml with menu entries.
</objective>

<execution_context>
@C:\Users\chris\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\chris\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-time-limits-user-lists/04-CONTEXT.md
@.planning/phases/04-time-limits-user-lists/04-RESEARCH.md
@.planning/phases/04-time-limits-user-lists/04-01-SUMMARY.md
@backend/src/services/profile.rs
@backend/src/services/mod.rs
@backend/src/services/registry.rs
@config.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create User Profile Lookup Render Functions</name>
  <files>
    backend/src/services/user_profile.rs
    backend/src/services/mod.rs
  </files>
  <action>
1. Create backend/src/services/user_profile.rs:

   This module provides functions for looking up and displaying other users' profiles.
   It reuses the existing render_profile_card function from profile.rs but with is_own_profile=false.

   The lookup flow (handled in session.rs in Plan 06) is:
   - User selects "User Lookup" from menu
   - Session shows prompt: "Enter handle to look up: "
   - User types handle, presses Enter
   - Session queries DB for user by handle
   - If found, renders profile card (read-only, no edit menu)
   - If not found, shows error message
   - After viewing, "Press any key to return"

   Create render functions:
   ```rust
   use crate::terminal::{AnsiWriter, Color};

   /// Render the user lookup prompt screen.
   pub fn render_lookup_prompt() -> String {
       let mut w = AnsiWriter::new();
       w.clear_screen();
       w.set_fg(Color::Yellow);
       w.bold();
       w.writeln("  USER LOOKUP");
       w.reset_color();
       w.writeln("");
       w.set_fg(Color::LightCyan);
       w.write_str("  Enter handle to look up (or Q to cancel): ");
       w.reset_color();
       w.flush()
   }

   /// Render a "user not found" error message.
   pub fn render_user_not_found(handle: &str) -> String {
       let mut w = AnsiWriter::new();
       w.writeln("");
       w.set_fg(Color::LightRed);
       w.writeln(&format!("  User '{}' not found.", handle));
       w.reset_color();
       w.writeln("");
       w.set_fg(Color::LightCyan);
       w.writeln("  Press any key to try again...");
       w.reset_color();
       w.flush()
   }

   /// Render the "press any key" footer after viewing a profile.
   pub fn render_profile_footer() -> String {
       let mut w = AnsiWriter::new();
       w.writeln("");
       w.set_fg(Color::LightCyan);
       w.writeln("  Press any key to return...");
       w.reset_color();
       w.flush()
   }
   ```

   The actual profile card rendering reuses `render_profile_card(&user, false)` from profile.rs.
   The `false` parameter indicates it's not the user's own profile (no edit options).

   NOTE: The current render_profile_card always receives `is_own_profile` but doesn't use it to change rendering. The profile edit menu is rendered separately in session.rs. So viewing another user's profile = render_profile_card(&user, false) + render_profile_footer() (no edit menu).

2. Add `pub mod user_profile;` to backend/src/services/mod.rs.
  </action>
  <verify>
    `cargo check` passes with the new user_profile.rs module.
  </verify>
  <done>
    user_profile.rs exists with render_lookup_prompt, render_user_not_found, render_profile_footer.
    Profile lookup reuses existing render_profile_card for display.
    Module registered in services/mod.rs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register Phase 4 Menu Items in Config</name>
  <files>
    config.toml
  </files>
  <action>
1. Add Phase 4 menu items to config.toml.

   These features are accessible from the main menu (not a submenu) since they're core BBS features:

   ```toml
   # Phase 4: User Lists (main menu commands)
   [[menu.main]]
   type = "command"
   hotkey = "W"
   name = "Who's Online"
   command = "whos_online"
   order = 5

   [[menu.main]]
   type = "command"
   hotkey = "L"
   name = "Last Callers"
   command = "last_callers"
   order = 6

   [[menu.main]]
   type = "command"
   hotkey = "U"
   name = "User Lookup"
   command = "user_lookup"
   order = 7
   ```

   Place these AFTER the existing submenu entries (Games=1, Mail=2, Chat=3, News=4) and BEFORE Profile (90) and Quit (100).

   These are "command" type items (like Profile and Quit) because they're handled directly by session.rs, not through the Service trait. The session will match on these command strings in handle_authenticated_input.
  </action>
  <verify>
    Config.toml parses correctly (can verify with `cargo run` or a config parse test).
    Menu items appear with correct hotkeys and order.
  </verify>
  <done>
    Config.toml has W=Who's Online, L=Last Callers, U=User Lookup in main menu.
    Items ordered between submenus (1-4) and Profile/Quit (90, 100).
    All use "command" type for direct session handling.
  </done>
</task>

</tasks>

<verification>
- `cargo check` passes with new user_profile module
- Config.toml loads with new menu items
- Menu items use appropriate hotkeys (W, L, U) that don't conflict with existing
</verification>

<success_criteria>
- User profile lookup has prompt, not-found, and footer render functions
- Config.toml has all three Phase 4 menu items
- Hotkeys W, L, U don't conflict with existing G, M, C, N, P, Q
- Items properly ordered in main menu
</success_criteria>

<output>
After completion, create `.planning/phases/04-time-limits-user-lists/04-05-SUMMARY.md`
</output>
