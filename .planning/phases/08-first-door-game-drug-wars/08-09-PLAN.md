---
phase: 08-first-door-game-drug-wars
plan: 09
type: execute
wave: 4
depends_on: ["08-08"]
files_modified:
  - backend/src/game/screen.rs
  - backend/src/game/render.rs
  - backend/src/websocket/session.rs
autonomous: false

must_haves:
  truths:
    - "All game screens render correctly"
    - "Trading flow works end-to-end"
    - "Random events trigger and resolve"
    - "Game can be completed (90 days or death)"
  artifacts:
    - path: "backend/src/websocket/session.rs"
      provides: "Complete GTM integration"
      contains: "handle_gtm_input"
  key_links:
    - from: "session.rs"
      to: "game/screen.rs"
      via: "GtmFlow input handling"
      pattern: "handle_char"
---

<objective>
Final integration and end-to-end verification of Grand Theft Meth.

Purpose: Ensure all game systems work together - trading, travel, events, economy, quests - and the complete game loop functions from start to finish.
Output: Fully playable door game accessible from BBS menu.
</objective>

<execution_context>
@C:\Users\chris\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\chris\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-first-door-game-drug-wars/08-CONTEXT.md
@.planning/phases/08-first-door-game-drug-wars/08-08-SUMMARY.md
@backend/src/websocket/session.rs
@backend/src/game/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix any compilation errors and integrate all game modules</name>
  <files>backend/src/game/mod.rs, backend/src/game/screen.rs, backend/src/lib.rs</files>
  <action>
Ensure all game modules compile and work together.

1. Verify backend/src/game/mod.rs exports all modules:
```rust
pub mod state;
pub mod data;
pub mod screen;
pub mod render;
pub mod events;
pub mod economy;
pub mod quest;

pub use state::*;
pub use data::*;
pub use screen::*;
pub use render::*;
pub use events::*;
pub use economy::*;
pub use quest::*;
```

2. Ensure backend/src/lib.rs has `pub mod game;`

3. Fix any cross-module reference issues in screen.rs by using fully qualified paths or proper imports.

4. Run cargo check and fix any compilation errors.
  </action>
  <verify>
`cargo check` in backend directory completes without errors.
  </verify>
  <done>
All game modules compile together.
No unresolved references or type errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify screen transition flow</name>
  <files>backend/src/game/screen.rs</files>
  <action>
Test the state machine flow by tracing through common paths:

1. Intro -> MainMenu (any key)
2. MainMenu -> Travel (T) -> select borough (1-4) -> MainMenu
3. MainMenu -> Trade (B) -> Buy (B) -> select drug (1-11) -> enter quantity -> MainMenu
4. MainMenu -> LoanShark (L) -> Pay/Borrow -> MainMenu
5. MainMenu -> Quit (X) -> confirm (Y) -> exit

Ensure each transition:
- Updates screen correctly
- Returns appropriate GtmAction
- Triggers SaveGame when state changes

Fix any broken transitions.
  </action>
  <verify>
State machine handles all documented transitions.
No panics or unreachable code.
  </verify>
  <done>
All major screen transitions work correctly.
State changes trigger saves.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Grand Theft Meth door game with:
    - Main menu with all options (Travel, Trade, Loan Shark, Bank, Hospital, Guns, Casino, Quests)
    - Buy/sell commodities with price display
    - Travel between cities and boroughs
    - Random events (police, muggers, price deals)
    - Loan shark borrowing and payment
    - Bank deposits/withdrawals (unlocks at $50k)
    - Combat resolution
    - Quest system with 15-step story
    - Save/resume functionality
    - Leaderboard display
    - 90-day game limit
  </what-built>
  <how-to-verify>
    1. Start the BBS server: `cargo run` in backend directory
    2. Open browser to http://localhost:3000
    3. Log in or create account
    4. Press G to enter Games submenu
    5. Press 1 to launch Grand Theft Meth

    Test core gameplay:
    - Press any key to skip intro
    - Press T to travel, select a borough
    - Press B to trade, try buying and selling
    - Press L to visit loan shark
    - Press X to quit, confirm with Y
    - Re-launch game - should resume from save

    Verify:
    - Status bar shows day, cash, debt, health
    - Prices vary by location
    - Buying reduces cash, selling increases it
    - Travel costs actions (5 per day)
    - Days advance when actions depleted
    - Debt grows with daily interest (visible on loan shark screen)
  </how-to-verify>
  <resume-signal>Type "approved" if game is playable, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Cargo check passes.
Game launches from menu.
Core gameplay loop works (buy low, sell high, manage debt).
Save/resume functions correctly.
</verification>

<success_criteria>
- User can play complete game session
- Trading modifies cash and inventory correctly
- Travel uses actions and changes location
- Days advance with interest applied
- Game saves on quit, resumes on relaunch
- Game ends at day 90 or player death
- Leaderboard shows completed games
</success_criteria>

<output>
After completion, create `.planning/phases/08-first-door-game-drug-wars/08-09-SUMMARY.md`
</output>
