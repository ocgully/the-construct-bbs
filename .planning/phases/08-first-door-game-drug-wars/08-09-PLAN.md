---
phase: 08-first-door-game-drug-wars
plan: 09
type: execute
wave: 4
depends_on: ["08-08"]
files_modified:
  - backend/src/game/screen.rs
  - backend/src/game/render.rs
  - backend/src/game/tests.rs
  - backend/src/websocket/session.rs
autonomous: false

must_haves:
  truths:
    - "All game screens render correctly"
    - "Trading flow works end-to-end"
    - "Random events trigger and resolve"
    - "Game can be completed (90 days or death)"
    - "Unit tests pass for all game modules"
    - "Integration tests verify complete game flows"
  artifacts:
    - path: "backend/src/game/tests.rs"
      provides: "Comprehensive test suite for GTM"
      contains: "#[cfg(test)]"
  key_links:
    - from: "session.rs"
      to: "game/screen.rs"
      via: "GtmFlow input handling"
      pattern: "handle_char"
---

<objective>
Final integration, unit tests, and automated UAT for Grand Theft Meth.

Purpose: Ensure all game systems work together - trading, travel, events, economy, quests - and verify with comprehensive test coverage that iterates until all tests pass.
Output: Fully playable and tested door game accessible from BBS menu.
</objective>

<execution_context>
@C:\Users\chris\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\chris\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-first-door-game-drug-wars/08-CONTEXT.md
@.planning/phases/08-first-door-game-drug-wars/08-08-SUMMARY.md
@backend/src/websocket/session.rs
@backend/src/game/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix any compilation errors and integrate all game modules</name>
  <files>backend/src/game/mod.rs, backend/src/game/screen.rs, backend/src/lib.rs</files>
  <action>
Ensure all game modules compile and work together.

1. Verify backend/src/game/mod.rs exports all modules
2. Ensure backend/src/lib.rs has `pub mod game;`
3. Fix any cross-module reference issues
4. Run cargo check and fix any compilation errors
  </action>
  <verify>
`cargo check` in backend directory completes without errors.
  </verify>
  <done>
All game modules compile together.
No unresolved references or type errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create unit tests for GameState</name>
  <files>backend/src/game/state.rs</files>
  <action>
Add unit tests for GameState in a tests module:

```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_new_game_initial_state() {
        let state = GameState::new();
        assert_eq!(state.day, 1);
        assert_eq!(state.cash, 200000); // $2,000
        assert_eq!(state.debt, 550000); // $5,500
        assert_eq!(state.health, 100);
        assert_eq!(state.actions_remaining, 5);
        assert_eq!(state.location, "bronx");
        assert_eq!(state.city, "nyc");
    }

    #[test]
    fn test_inventory_operations() {
        let mut state = GameState::new();
        state.add_inventory("weed", 10, 1500);
        assert_eq!(state.get_quantity("weed"), 10);

        state.remove_inventory("weed", 5);
        assert_eq!(state.get_quantity("weed"), 5);
    }

    #[test]
    fn test_coat_capacity() {
        let mut state = GameState::new();
        assert_eq!(state.coat_capacity(), 100);
        state.coat_tier = 1;
        assert_eq!(state.coat_capacity(), 125);
        state.coat_tier = 3;
        assert_eq!(state.coat_capacity(), 250);
    }

    #[test]
    fn test_debt_interest() {
        let mut state = GameState::new();
        state.debt = 100000; // $1,000
        state.apply_debt_interest();
        assert_eq!(state.debt, 110000); // $1,100 (10% interest)
    }

    #[test]
    fn test_bank_interest() {
        let mut state = GameState::new();
        state.bank_unlocked = true;
        state.bank_balance = 100000; // $1,000
        state.apply_bank_interest();
        assert_eq!(state.bank_balance, 105000); // $1,050 (5% interest)
    }

    #[test]
    fn test_net_worth_calculation() {
        let mut state = GameState::new();
        state.cash = 100000;
        state.bank_balance = 50000;
        state.debt = 30000;
        let prices = std::collections::HashMap::new();
        assert_eq!(state.net_worth(&prices), 120000); // 100k + 50k - 30k
    }

    #[test]
    fn test_high_tier_sober_up() {
        let mut state = GameState::new();
        state.high_tier = 3;
        state.last_login_date = Some("2020-01-01".to_string());
        let sobered = state.check_new_day_sober_up();
        assert!(sobered);
        assert_eq!(state.high_tier, 0);
    }
}
```
  </action>
  <verify>
`cargo test state::tests` passes all tests.
  </verify>
  <done>
GameState unit tests cover:
- Initial state values
- Inventory add/remove
- Coat capacity tiers
- Debt and bank interest
- Net worth calculation
- High tier sober up mechanic
  </done>
</task>

<task type="auto">
  <name>Task 3: Create unit tests for economy module</name>
  <files>backend/src/game/economy.rs</files>
  <action>
Add unit tests for economy functions:

```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_generate_prices_within_range() {
        let prices = generate_prices();
        for commodity in crate::game::COMMODITIES {
            let price = prices.get(commodity.key).unwrap();
            assert!(*price >= commodity.min_price);
            assert!(*price <= commodity.max_price);
        }
    }

    #[test]
    fn test_format_money() {
        assert_eq!(format_money(0), "$0.00");
        assert_eq!(format_money(100), "$1.00");
        assert_eq!(format_money(12345), "$123.45");
        assert_eq!(format_money(1234567), "$12,345.67");
        assert_eq!(format_money(-5000), "-$50.00");
    }
}
```
  </action>
  <verify>
`cargo test economy::tests` passes all tests.
  </verify>
  <done>
Economy tests verify price generation and money formatting.
  </done>
</task>

<task type="auto">
  <name>Task 4: Create unit tests for events module</name>
  <files>backend/src/game/events.rs</files>
  <action>
Add unit tests for event resolution:

```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_combat_result_application() {
        let mut state = GameState::new();
        state.health = 100;

        let result = CombatResult {
            player_won: true,
            player_damage: 20,
            enemy_killed: true,
            loot_cash: 5000,
            notoriety_change: 5,
            message: "Victory!".to_string(),
        };

        apply_combat_result(&mut state, &result);

        assert_eq!(state.health, 80);
        assert_eq!(state.cash, 205000); // 200000 + 5000
        assert_eq!(state.notoriety, 5);
        assert_eq!(state.stats.people_killed, 1);
    }

    #[test]
    fn test_find_cash_event() {
        let mut state = GameState::new();
        let event = GameEvent::FindCash { amount: 10000 };
        apply_find_event(&event, &mut state);
        assert_eq!(state.cash, 210000);
    }

    #[test]
    fn test_find_drugs_event() {
        let mut state = GameState::new();
        let event = GameEvent::FindDrugs {
            commodity: "weed".to_string(),
            amount: 5,
        };
        apply_find_event(&event, &mut state);
        assert_eq!(state.get_quantity("weed"), 5);
    }

    #[test]
    fn test_trenchcoat_upgrade() {
        let mut state = GameState::new();
        state.coat_tier = 0;
        let msg = handle_trenchcoat_upgrade(&mut state, true);
        assert_eq!(state.coat_tier, 1);
        assert!(msg.contains("125"));
    }
}
```
  </action>
  <verify>
`cargo test events::tests` passes all tests.
  </verify>
  <done>
Event tests verify combat resolution, find events, and trenchcoat upgrades.
  </done>
</task>

<task type="auto">
  <name>Task 5: Create unit tests for quest module</name>
  <files>backend/src/game/quest.rs</files>
  <action>
Add unit tests for quest system:

```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_gang_status_text() {
        assert_eq!(gang_status(75), "Allied");
        assert_eq!(gang_status(25), "Neutral");
        assert_eq!(gang_status(-25), "Hostile");
        assert_eq!(gang_status(-75), "Enemy");
    }

    #[test]
    fn test_story_step_count() {
        assert_eq!(STORY_STEPS.len(), 15);
    }

    #[test]
    fn test_get_current_story() {
        let mut state = GameState::new();
        state.quest_state.story_step = 0;
        let step = get_current_story(&state);
        assert!(step.is_some());
        assert_eq!(step.unwrap().step, 1);
        assert_eq!(step.unwrap().title, "The Old Contact");
    }

    #[test]
    fn test_is_story_complete() {
        let mut state = GameState::new();
        state.quest_state.story_step = 14;
        assert!(!is_story_complete(&state));
        state.quest_state.story_step = 15;
        assert!(is_story_complete(&state));
    }
}
```
  </action>
  <verify>
`cargo test quest::tests` passes all tests.
  </verify>
  <done>
Quest tests verify gang status, story progression, and completion detection.
  </done>
</task>

<task type="auto">
  <name>Task 6: Create integration tests for GtmFlow</name>
  <files>backend/src/game/screen.rs</files>
  <action>
Add integration tests for the game flow state machine:

```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_new_game_starts_at_intro() {
        let flow = GtmFlow::new();
        assert!(matches!(flow.current_screen(), GameScreen::Intro));
    }

    #[test]
    fn test_intro_to_main_menu() {
        let mut flow = GtmFlow::new();
        flow.screen = GameScreen::Intro;
        // Simulate any key press
        flow.handle_intro("x");
        assert!(matches!(flow.current_screen(), GameScreen::MainMenu));
    }

    #[test]
    fn test_travel_screen_transition() {
        let mut flow = GtmFlow::new();
        flow.screen = GameScreen::MainMenu;
        // Would need to call handle_main_menu("T") and verify screen changes
    }

    #[test]
    fn test_trade_buy_reduces_cash() {
        let mut flow = GtmFlow::new();
        flow.screen = GameScreen::MainMenu;
        let initial_cash = flow.state.cash;

        // Simulate buying something - verify cash decreases
        // This tests the economic loop
    }

    #[test]
    fn test_day_advance_on_zero_actions() {
        let mut flow = GtmFlow::new();
        flow.state.actions_remaining = 1;
        let initial_day = flow.state.day;

        flow.use_action();

        assert_eq!(flow.state.day, initial_day + 1);
        assert_eq!(flow.state.actions_remaining, 5);
    }

    #[test]
    fn test_game_over_at_day_90() {
        let mut flow = GtmFlow::new();
        flow.state.day = 89;
        flow.state.actions_remaining = 1;

        flow.use_action();

        assert_eq!(flow.state.day, 90);
        assert!(flow.state.game_over);
    }
}
```
  </action>
  <verify>
`cargo test screen::tests` passes all tests.
  </verify>
  <done>
Integration tests verify:
- Screen transitions
- Economic operations
- Day advancement
- Game over conditions
  </done>
</task>

<task type="auto">
  <name>Task 7: Run full test suite and fix failures</name>
  <files>backend/src/game/*.rs</files>
  <action>
Run the complete test suite and iterate until all tests pass:

1. Run `cargo test --package bbs-backend` to execute all tests
2. For each failing test:
   - Identify the root cause
   - Fix the implementation or adjust the test
   - Re-run tests
3. Continue until all tests pass

Common issues to watch for:
- Borrow checker issues in tests
- Incorrect expected values
- Missing imports in test modules
- Private functions that need `pub(crate)` for testing
  </action>
  <verify>
`cargo test` shows all tests passing with no failures.
  </verify>
  <done>
All unit and integration tests pass.
Test coverage includes state, economy, events, quests, and flow.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Grand Theft Meth door game with comprehensive test suite:
    - Main menu with all options (Travel, Trade, Loan Shark, Bank, Hospital, Guns, Casino, Quests)
    - Buy/sell commodities with price display
    - Travel between cities and boroughs
    - Random events (police, muggers, price deals)
    - Loan shark borrowing and payment
    - Bank deposits/withdrawals (unlocks at $50k)
    - Combat resolution
    - Quest system with 15-step story
    - High/intoxication visual effects
    - Save/resume functionality
    - Leaderboard display
    - 90-day game limit
    - Unit tests for all modules
    - Integration tests for game flows
  </what-built>
  <how-to-verify>
    1. Run test suite: `cd backend && cargo test`
    2. Verify all tests pass

    3. Start the BBS server: `cargo run` in backend directory
    4. Open browser to http://localhost:3000
    5. Log in or create account
    6. Press G to enter Games submenu
    7. Press 1 to launch Grand Theft Meth

    Test core gameplay:
    - Press any key to skip intro
    - Press T to travel, select a borough
    - Press B to trade, try buying and selling
    - Press U to use drugs (if you have inventory)
    - Press L to visit loan shark
    - Press H to visit hospital (if in right location)
    - Press X to quit, confirm with Y
    - Re-launch game - should resume from save

    Verify:
    - Status bar shows day, cash, debt, health, high status
    - Prices vary by location
    - Buying reduces cash, selling increases it
    - Using drugs affects high tier and actions
    - Travel costs actions (5 per day)
    - Days advance when actions depleted
    - Debt grows with daily interest
    - Hospital can heal HP and detox high status
  </how-to-verify>
  <resume-signal>Type "approved" if game and tests work, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Cargo test passes all tests.
Game launches from menu.
Core gameplay loop works (buy low, sell high, manage debt).
Save/resume functions correctly.
High effects display and can be cleared.
</verification>

<success_criteria>
- All unit tests pass (state, economy, events, quests)
- All integration tests pass (screen flow, game loop)
- User can play complete game session
- Trading modifies cash and inventory correctly
- Travel uses actions and changes location
- Days advance with interest applied
- High effects render and decay properly
- Game saves on quit, resumes on relaunch
- Game ends at day 90 or player death
- Leaderboard shows completed games
</success_criteria>

<output>
After completion, create `.planning/phases/08-first-door-game-drug-wars/08-09-SUMMARY.md`
</output>
