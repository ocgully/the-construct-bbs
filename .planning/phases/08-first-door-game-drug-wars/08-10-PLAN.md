---
phase: 08-first-door-game-drug-wars
plan: 10
type: execute
wave: 5
depends_on: ["08-09"]
files_modified:
  - backend/src/games/mod.rs
  - backend/src/games/grand_theft_meth/mod.rs
  - backend/src/games/grand_theft_meth/*.rs
  - backend/src/lib.rs
  - backend/src/websocket/session.rs
  - .claude/settings.local.json
autonomous: true

must_haves:
  truths:
    - "Grand Theft Meth moved to backend/src/games/grand_theft_meth/"
    - "Old backend/src/game/ folder removed"
    - "All imports updated throughout codebase"
    - "Pattern documented in CLAUDE.md for future games"
    - "Cargo check passes with no errors"
    - "All existing tests still pass"
  artifacts:
    - path: "backend/src/games/mod.rs"
      provides: "Games module registry"
      contains: "pub mod grand_theft_meth"
    - path: "backend/src/games/grand_theft_meth/mod.rs"
      provides: "GTM module exports"
      contains: "pub mod"
---

<objective>
Restructure game code from /game/ to /games/grand_theft_meth/ for scalable multi-game architecture.

Purpose: Enable clean addition of future door games (LORD, Usurper, Acrophobia, Kyrandia) by establishing proper folder structure.
Output: Each game in its own namespaced folder under /games/.
</objective>

<execution_context>
@C:\Users\chris\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\chris\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@backend/src/game/mod.rs
@backend/src/lib.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create new games folder structure</name>
  <files>backend/src/games/mod.rs, backend/src/games/grand_theft_meth/mod.rs</files>
  <action>
1. Create backend/src/games/ directory
2. Create backend/src/games/mod.rs:
   ```rust
   //! Door games module - each game in its own subfolder
   //!
   //! Structure:
   //! - games/
   //!   - mod.rs (this file - registers all games)
   //!   - grand_theft_meth/ (Drug Wars clone)
   //!   - lord/ (Legend of the Red Dragon - future)
   //!   - usurper/ (Medieval RPG - future)
   //!   - acrophobia/ (Multiplayer party game - future)
   //!   - kyrandia/ (MUD - future)

   pub mod grand_theft_meth;
   ```

3. Create backend/src/games/grand_theft_meth/ directory
4. Create backend/src/games/grand_theft_meth/mod.rs with proper exports
  </action>
  <verify>
Directory structure exists.
  </verify>
  <done>
New folder structure created:
- backend/src/games/mod.rs
- backend/src/games/grand_theft_meth/
  </done>
</task>

<task type="auto">
  <name>Task 2: Move game files to new location</name>
  <files>backend/src/games/grand_theft_meth/*.rs</files>
  <action>
Move all files from backend/src/game/ to backend/src/games/grand_theft_meth/:

1. Move these files:
   - db.rs
   - economy.rs
   - events.rs
   - quest.rs
   - render.rs
   - screen.rs
   - state.rs

2. Update backend/src/games/grand_theft_meth/mod.rs:
   ```rust
   //! Grand Theft Meth - Drug Wars clone
   //!
   //! A commodities trading game where players buy/sell substances
   //! across cities, manage debt, encounter random events, and
   //! complete a 15-step story quest.

   pub mod db;
   pub mod economy;
   pub mod events;
   pub mod quest;
   pub mod render;
   pub mod screen;
   pub mod state;

   // Re-export key types for external use
   pub use db::GtmDb;
   pub use screen::{GtmFlow, GtmAction, GameScreen};
   pub use state::GameState;
   pub use render::format_money;

   // Re-export static data
   pub use state::{COMMODITIES, CITIES, WEAPONS, GANGS};
   ```
  </action>
  <verify>
All files moved to new location.
Old backend/src/game/ can be deleted.
  </verify>
  <done>
All GTM files moved to backend/src/games/grand_theft_meth/.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update internal module references</name>
  <files>backend/src/games/grand_theft_meth/*.rs</files>
  <action>
Update all internal references within GTM files:

1. In each file, update crate references:
   - `crate::game::` → `crate::games::grand_theft_meth::`
   - `super::` references should still work within the module

2. Update use statements in each file to reference siblings correctly:
   ```rust
   // Example in screen.rs
   use super::state::{GameState, COMMODITIES, CITIES};
   use super::render::{render_main_menu, format_money};
   use super::events::{check_random_event, resolve_combat};
   // etc.
   ```

3. Fix any remaining internal imports
  </action>
  <verify>
All internal references updated.
No crate::game:: references remain.
  </verify>
  <done>
All internal module references updated to new paths.
  </done>
</task>

<task type="auto">
  <name>Task 4: Update external references</name>
  <files>backend/src/lib.rs, backend/src/websocket/session.rs, backend/src/services/grand_theft_meth/service.rs</files>
  <action>
Update all external references to the game module:

1. In backend/src/lib.rs:
   - Remove `pub mod game;`
   - Add `pub mod games;`

2. In backend/src/websocket/session.rs:
   - Update all `use crate::game::` to `use crate::games::grand_theft_meth::`

3. In backend/src/services/grand_theft_meth/service.rs:
   - Update all game imports to new path:
   ```rust
   use crate::games::grand_theft_meth::{
       GtmDb, GtmFlow, GtmAction, GameScreen, GameState,
       format_money,
   };
   ```

4. Search for any other references:
   ```bash
   grep -r "crate::game::" backend/src/
   ```
   And update them all.
  </action>
  <verify>
`grep -r "crate::game::" backend/src/` returns no results.
  </verify>
  <done>
All external references updated:
- lib.rs exports games module
- session.rs uses new path
- service.rs uses new path
  </done>
</task>

<task type="auto">
  <name>Task 5: Remove old game folder</name>
  <files>backend/src/game/</files>
  <action>
1. Verify all files have been moved
2. Delete backend/src/game/ folder entirely
3. Ensure no orphaned references
  </action>
  <verify>
backend/src/game/ no longer exists.
  </verify>
  <done>
Old game folder removed.
  </done>
</task>

<task type="auto">
  <name>Task 6: Update CLAUDE.md with game pattern</name>
  <files>.claude/settings.local.json or CLAUDE.md</files>
  <action>
Document the door game pattern for future development.

If CLAUDE.md exists, add section. Otherwise create .claude/CLAUDE.md:

```markdown
# Door Games Architecture

## Folder Structure

Each door game lives in its own subfolder under `backend/src/games/`:

```
backend/src/games/
├── mod.rs              # Registers all games
├── grand_theft_meth/   # Drug Wars clone
│   ├── mod.rs          # Module exports
│   ├── db.rs           # Game-specific database
│   ├── state.rs        # GameState and static data
│   ├── screen.rs       # Game flow state machine
│   ├── render.rs       # ANSI rendering functions
│   ├── events.rs       # Random events and combat
│   ├── economy.rs      # Loan shark, bank, casino
│   └── quest.rs        # Story and delivery quests
├── lord/               # Legend of the Red Dragon (future)
├── usurper/            # Medieval RPG (future)
├── acrophobia/         # Multiplayer party game (future)
└── kyrandia/           # MUD (future)
```

## Key Patterns

1. **Self-contained database**: Each game has its own SQLite database file (e.g., `grand_theft_meth.db`), separate from the BBS database. This keeps games fully pluggable.

2. **GameState struct**: Each game defines its own `GameState` with serde serialization for save/resume.

3. **Flow state machine**: Each game has a `Flow` struct (e.g., `GtmFlow`) that manages screen transitions and returns actions for the session to handle.

4. **Action enum**: Games return actions (Continue, Echo, SaveGame, GameOver, Quit) that the session layer executes.

5. **Render functions return String**: All ANSI rendering functions return `String` for async compatibility - the session layer handles output.

6. **Service wrapper**: Each game has a service in `backend/src/services/{game_name}/` that handles the BBS integration.

## Adding a New Game

1. Create folder: `backend/src/games/{game_name}/`
2. Add module files: mod.rs, db.rs, state.rs, screen.rs, render.rs
3. Register in `backend/src/games/mod.rs`: `pub mod {game_name};`
4. Create service: `backend/src/services/{game_name}/`
5. Add to menu config: `config.toml` Games submenu
6. Create database on first launch (not at BBS startup)
```
  </action>
  <verify>
CLAUDE.md contains door game architecture documentation.
  </verify>
  <done>
Door game pattern documented:
- Folder structure
- Key patterns (self-contained DB, state machine, actions)
- Steps to add new games
  </done>
</task>

<task type="auto">
  <name>Task 7: Verify compilation and tests</name>
  <files>backend/src/**/*.rs</files>
  <action>
1. Run cargo check to verify compilation:
   ```bash
   cd backend && cargo check
   ```

2. Fix any remaining errors

3. Run all tests:
   ```bash
   cd backend && cargo test
   ```

4. Ensure all 229 tests still pass
  </action>
  <verify>
`cargo check` passes with no errors.
`cargo test` shows all tests passing.
  </verify>
  <done>
Compilation successful.
All tests pass after restructure.
  </done>
</task>

</tasks>

<verification>
Folder structure: backend/src/games/grand_theft_meth/
No references to old crate::game:: path.
Cargo check passes.
All tests pass.
CLAUDE.md documents the pattern.
</verification>

<success_criteria>
- Grand Theft Meth in backend/src/games/grand_theft_meth/
- Old backend/src/game/ folder deleted
- All imports updated throughout codebase
- Pattern documented in CLAUDE.md
- Cargo check passes
- All 229 tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/08-first-door-game-drug-wars/08-10-SUMMARY.md`
</output>
