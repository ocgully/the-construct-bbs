---
phase: 08-first-door-game-drug-wars
plan: 08
type: execute
wave: 4
depends_on: ["08-01", "08-03", "08-04"]
files_modified:
  - backend/src/services/grand_theft_meth/service.rs
  - backend/src/services/grand_theft_meth/mod.rs
  - backend/src/websocket/session.rs
  - backend/src/connection/state.rs
  - config.toml
autonomous: true

must_haves:
  truths:
    - "User can launch Grand Theft Meth from Games submenu"
    - "Game state persists between sessions (using game's own database)"
    - "Leaderboard displays top 10 players"
  artifacts:
    - path: "backend/src/services/grand_theft_meth/service.rs"
      provides: "Game service integration"
      exports: ["start_game", "save_game_state", "SENTINEL"]
    - path: "config.toml"
      provides: "Menu entry for game"
      contains: "grand_theft_meth"
  key_links:
    - from: "backend/src/websocket/session.rs"
      to: "backend/src/services/grand_theft_meth/service.rs"
      via: "sentinel service __game_gtm__"
      pattern: "__game_gtm__"
    - from: "backend/src/services/grand_theft_meth/db.rs"
      to: "backend/src/services/grand_theft_meth/service.rs"
      via: "GtmDb instance in AppState"
      pattern: "gtm_db"
---

<objective>
Integrate Grand Theft Meth into the BBS session with menu wiring, save/load, and leaderboard.

Purpose: This is the final integration that makes the game playable. Users can launch from menu, play, save, quit, resume, and view leaderboards. The game uses its own self-contained database.
Output: Complete service integration with session routing and menu configuration.
</objective>

<execution_context>
@C:\Users\chris\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\chris\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-first-door-game-drug-wars/08-CONTEXT.md
@.planning/phases/08-first-door-game-drug-wars/08-RESEARCH.md
@backend/src/websocket/session.rs
@backend/src/services/grand_theft_meth/mod.rs
@backend/src/services/grand_theft_meth/db.rs
@backend/src/connection/state.rs
@config.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create service module with self-contained database</name>
  <files>backend/src/services/grand_theft_meth/service.rs, backend/src/services/grand_theft_meth/mod.rs</files>
  <action>
Create backend/src/services/grand_theft_meth/service.rs with service module.

This uses the self-contained GtmDb for all persistence (no BBS db_pool).

```rust
//! Grand Theft Meth - Door Game Service
//!
//! A commodity trading game where players buy/sell drugs across cities,
//! encounter random events, manage debt, and compete for high scores.
//!
//! Uses __game_gtm__ sentinel for session routing (similar to __chat__, __mail__).
//! Game state persisted in game's own database (grand_theft_meth.db).

use crate::services::grand_theft_meth::db::{GtmDb, LeaderboardEntry};
use crate::services::grand_theft_meth::state::GameState;
use crate::services::grand_theft_meth::screen::{GtmFlow, GtmAction, GameScreen};
use crate::services::grand_theft_meth::render::*;

/// Sentinel for session routing
pub const SENTINEL: &str = "__game_gtm__";

/// Initialize or resume a game session
pub async fn start_game(db: &GtmDb, user_id: i64, handle: &str) -> Result<(GtmFlow, String), String> {
    // Check for existing save
    match db.load_game(user_id).await {
        Ok(Some(json)) => {
            // Resume existing game
            match serde_json::from_str::<GameState>(&json) {
                Ok(state) => {
                    let flow = GtmFlow::from_state(state);
                    let screen = render_screen(&flow);
                    Ok((flow, screen))
                }
                Err(e) => {
                    // Corrupted save, offer to start fresh
                    Err(format!("Save corrupted: {}. Start new game.", e))
                }
            }
        }
        Ok(None) => {
            // New game
            let flow = GtmFlow::new();
            let screen = render_intro();
            Ok((flow, screen))
        }
        Err(e) => Err(format!("Database error: {}", e)),
    }
}

/// Save current game state
pub async fn save_game_state(db: &GtmDb, user_id: i64, handle: &str, flow: &GtmFlow) -> Result<(), String> {
    let json = serde_json::to_string(flow.game_state())
        .map_err(|e| format!("Serialize error: {}", e))?;

    db.save_game(user_id, handle, &json)
        .await
        .map_err(|e| format!("Save error: {}", e))
}

/// Delete save and start fresh
pub async fn clear_save(db: &GtmDb, user_id: i64) -> Result<(), String> {
    db.delete_save(user_id)
        .await
        .map_err(|e| format!("Delete error: {}", e))
}

/// Record game completion
pub async fn record_game_completion(
    db: &GtmDb,
    user_id: i64,
    handle: &str,
    flow: &GtmFlow,
) -> Result<(), String> {
    let state = flow.game_state();
    let prices = &flow.prices;
    let final_score = state.net_worth(prices);
    let days_played = state.day as i64;
    let story_completed = state.quest_state.story_step >= 15;

    db.record_completion(
        user_id,
        handle,
        final_score,
        days_played,
        story_completed,
    )
    .await
    .map_err(|e| format!("Record error: {}", e))?;

    // Delete save after completion
    let _ = db.delete_save(user_id).await;

    Ok(())
}

/// Get leaderboard for display
pub async fn get_game_leaderboard(db: &GtmDb) -> Vec<LeaderboardEntry> {
    match db.get_leaderboard(10).await {
        Ok(entries) => entries,
        Err(_) => Vec::new(),
    }
}

/// Render current screen based on game state
pub fn render_screen(flow: &GtmFlow) -> String {
    let state = flow.game_state();
    let prices = &flow.prices;

    match flow.current_screen() {
        GameScreen::Intro => render_intro(),
        GameScreen::MainMenu => render_main_menu(state, prices),
        GameScreen::Travel { selecting_city } => render_travel(state, prices, *selecting_city),
        GameScreen::Trade { mode } => render_trade(state, prices, mode),
        GameScreen::Combat { enemy_type, enemy_hp } => render_combat(state, prices, enemy_type, *enemy_hp),
        GameScreen::Event { event } => render_event(state, prices, event),
        GameScreen::LoanShark => render_loan_shark(state, prices),
        GameScreen::Bank => render_bank(state, prices),
        GameScreen::Hospital { is_mob_doctor } => render_hospital(state, prices, *is_mob_doctor),
        GameScreen::GunShop => render_gun_shop(state, prices),
        GameScreen::Quest => render_quest(state, prices),
        GameScreen::Casino { .. } => render_casino_menu(state, prices),
        GameScreen::GameOver => render_game_over(state, prices),
        GameScreen::Leaderboard => "Loading leaderboard...".to_string(),
        GameScreen::ConfirmQuit => render_confirm_quit(),
    }
}
```

Update backend/src/services/grand_theft_meth/mod.rs to add:
```rust
pub mod db;
pub mod service;
// ... other modules ...

pub use db::GtmDb;
pub use service::{SENTINEL, start_game, save_game_state, render_screen};
```
  </action>
  <verify>
Run `cargo check` - compiles without errors.
  </verify>
  <done>
Service module provides start_game, save_game_state, record_game_completion.
All functions use GtmDb (game's own database), not BBS db_pool.
SENTINEL constant for session routing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add GtmDb to AppState and wire into session</name>
  <files>backend/src/connection/state.rs, backend/src/websocket/session.rs</files>
  <action>
Update backend/src/connection/state.rs to include GtmDb in AppState.

Add field:
```rust
/// Grand Theft Meth game database (self-contained)
pub gtm_db: Arc<crate::services::grand_theft_meth::GtmDb>,
```

Initialize in AppState::new (or wherever AppState is constructed):
```rust
// Initialize game database (creates grand_theft_meth.db if needed)
let gtm_db = Arc::new(
    crate::services::grand_theft_meth::GtmDb::new(
        std::path::Path::new("data/grand_theft_meth.db")
    ).await.expect("Failed to initialize GTM database")
);
```

Update session.rs to handle Grand Theft Meth game.

Add field to Session struct:
```rust
/// Active Grand Theft Meth game state
gtm_flow: Option<crate::services::grand_theft_meth::screen::GtmFlow>,
```

Initialize in Session::new:
```rust
gtm_flow: None,
```

Add handler function:
```rust
/// Handle input for Grand Theft Meth game
async fn handle_gtm_input(&mut self, input: &str) {
    use crate::services::grand_theft_meth::{
        SENTINEL, render_screen, save_game_state, record_game_completion, get_game_leaderboard,
    };
    use crate::services::grand_theft_meth::screen::{GtmAction, GameScreen};

    let flow = match &mut self.gtm_flow {
        Some(f) => f,
        None => return,
    };

    // Process each character
    for ch in input.chars() {
        let action = flow.handle_char(ch);

        match action {
            GtmAction::Continue => {}
            GtmAction::Echo(s) => {
                let _ = self.tx.send(s).await;
            }
            GtmAction::Render(s) => {
                let _ = self.tx.send(s).await;
            }
            GtmAction::SaveGame => {
                // Save to game's own database
                if let AuthState::Authenticated { user_id, handle, .. } = &self.auth_state {
                    let _ = save_game_state(&self.state.gtm_db, *user_id, handle, flow).await;
                }
                // Render new screen
                let screen = render_screen(flow);
                let _ = self.tx.send(screen).await;
            }
            GtmAction::GameOver { final_score, story_completed } => {
                // Record completion
                if let AuthState::Authenticated { user_id, handle, .. } = &self.auth_state {
                    let _ = record_game_completion(
                        &self.state.gtm_db,
                        *user_id,
                        handle,
                        flow,
                    ).await;
                }

                // Show game over screen
                let screen = render_screen(flow);
                let _ = self.tx.send(screen).await;

                // Exit game on next input
                self.gtm_flow = None;
                self.current_service = None;
                if let Some(ms) = &mut self.menu_session {
                    ms.reset_to_main();
                }
            }
            GtmAction::Quit => {
                // Save and exit
                if let AuthState::Authenticated { user_id, handle, .. } = &self.auth_state {
                    let _ = save_game_state(&self.state.gtm_db, *user_id, handle, flow).await;
                }

                self.gtm_flow = None;
                self.current_service = None;
                if let Some(ms) = &mut self.menu_session {
                    ms.reset_to_main();
                }
                self.show_menu().await;
                return;
            }
        }
    }

    // Handle leaderboard screen specially (needs async data)
    if let Some(flow) = &self.gtm_flow {
        if matches!(flow.current_screen(), GameScreen::Leaderboard) {
            let entries = get_game_leaderboard(&self.state.gtm_db).await;
            let screen = crate::services::grand_theft_meth::render::render_leaderboard_screen(&entries);
            let _ = self.tx.send(screen).await;
        }
    }
}
```

Add to handle_authenticated_input (after chat/news checks):
```rust
// Grand Theft Meth game
if let Some(service_name) = &self.current_service {
    if service_name == crate::services::grand_theft_meth::SENTINEL {
        self.handle_gtm_input(input).await;
        return;
    }
}
```

Add launch handler in menu command processing:
```rust
"grand_theft_meth" => {
    use crate::services::grand_theft_meth::{SENTINEL, start_game};

    if let AuthState::Authenticated { user_id, handle, .. } = &self.auth_state {
        match start_game(&self.state.gtm_db, *user_id, handle).await {
            Ok((flow, screen)) => {
                self.gtm_flow = Some(flow);
                self.current_service = Some(SENTINEL.to_string());
                let _ = self.tx.send(screen).await;
            }
            Err(e) => {
                let mut w = AnsiWriter::new();
                w.set_fg(Color::LightRed);
                w.writeln(&format!("  Error: {}", e));
                w.reset_color();
                let _ = self.tx.send(w.flush()).await;
            }
        }
    }
}
```
  </action>
  <verify>
Run `cargo check` - compiles without errors.
  </verify>
  <done>
AppState has gtm_db field for game's self-contained database.
Session has gtm_flow field for active game state.
handle_gtm_input processes game input using game's own database.
Game launches from menu command processing.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add menu configuration for game</name>
  <files>config.toml</files>
  <action>
Update config.toml to enable the Games submenu and add Grand Theft Meth.

Uncomment and update the games submenu entry:

```toml
# Games submenu -- Door Games
[[menu.games]]
type = "service"
hotkey = "1"
name = "Grand Theft Meth"
service_name = "grand_theft_meth"
order = 1
# Door game: commodity trading with random events
```

Keep other games commented for future phases.

The Games submenu already exists in menu.main as:
```toml
[[menu.main]]
type = "submenu"
hotkey = "G"
name = "Games"
submenu_key = "games"
order = 1
```
  </action>
  <verify>
Run server and check menu structure. Games submenu should appear with Grand Theft Meth option.
  </verify>
  <done>
Games submenu accessible from main menu via G hotkey.
Grand Theft Meth listed as option 1 in Games submenu.
  </done>
</task>

</tasks>

<verification>
Run `cargo check && cargo test` - all pass.
Server starts without errors.
Game accessible from G > 1 menu path.
Game state persists after quit and resume (in grand_theft_meth.db, not bbs.db).
</verification>

<success_criteria>
- User can access Games menu from main menu (G hotkey)
- Grand Theft Meth appears as option in Games submenu
- Launching game shows intro or resumes from save
- Quitting game saves state and returns to menu
- Game over records completion and clears save
- Leaderboard displays top 10 scores
- All game data stored in grand_theft_meth.db (separate from bbs.db)
</success_criteria>

<output>
After completion, create `.planning/phases/08-first-door-game-drug-wars/08-08-SUMMARY.md`
</output>
