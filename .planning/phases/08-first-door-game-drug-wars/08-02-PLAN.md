---
phase: 08-first-door-game-drug-wars
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/game/mod.rs
  - backend/src/game/state.rs
  - backend/src/game/data.rs
  - backend/src/lib.rs
autonomous: true

must_haves:
  truths:
    - "GameState struct can be serialized to JSON and back"
    - "All locations, commodities, weapons, gangs are defined"
    - "Price ranges and game constants are configurable"
  artifacts:
    - path: "backend/src/game/state.rs"
      provides: "GameState with all game fields"
      exports: ["GameState", "WeaponSlots", "QuestProgress", "GameStats"]
    - path: "backend/src/game/data.rs"
      provides: "Static game data definitions"
      exports: ["CITIES", "COMMODITIES", "WEAPONS", "GANGS", "Location", "Commodity", "Weapon", "Gang"]
  key_links:
    - from: "backend/src/game/state.rs"
      to: "serde_json"
      via: "Serialize/Deserialize derives"
      pattern: "#\\[derive.*Serialize.*Deserialize"
---

<objective>
Define core game data structures and static game content.

Purpose: GameState is the central data structure persisted between sessions. All game logic operates on this struct. Static data defines the game world.
Output: Complete GameState struct with serde derives, plus all static game data (cities, commodities, weapons, gangs).
</objective>

<execution_context>
@C:\Users\chris\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\chris\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-first-door-game-drug-wars/08-CONTEXT.md
@.planning/phases/08-first-door-game-drug-wars/08-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create game module with GameState struct</name>
  <files>backend/src/game/mod.rs, backend/src/game/state.rs, backend/src/lib.rs</files>
  <action>
Create backend/src/game/ directory and files.

backend/src/game/mod.rs:
```rust
pub mod state;
pub mod data;

pub use state::*;
pub use data::*;
```

backend/src/game/state.rs:
Define GameState with all fields from RESEARCH.md:
```rust
use serde::{Serialize, Deserialize};
use std::collections::HashMap;

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct GameState {
    pub day: u32,                           // 1-90
    pub actions_remaining: u32,             // 5 per day base
    pub location: String,                   // Current borough key
    pub city: String,                       // Current city key
    pub cash: i64,                          // In cents to avoid float
    pub bank_balance: i64,                  // Unlocks at $50,000 threshold
    pub bank_unlocked: bool,
    pub mattress_stash: i64,                // Pre-bank storage (no interest)
    pub debt: i64,                          // Loan shark debt (10% daily)
    pub health: u32,                        // Current HP
    pub max_health: u32,                    // Base 100, can increase
    pub notoriety: u32,                     // Heat level 0-100
    pub inventory: HashMap<String, u32>,    // commodity_key -> quantity
    pub coat_tier: u32,                     // 0-3 (capacity: 100, 125, 150, 250)
    pub weapons: WeaponSlots,
    pub gang_relations: HashMap<String, i32>, // gang_key -> relation (-100 to 100)
    pub quest_state: QuestProgress,
    pub stats: GameStats,
    pub addiction: HashMap<String, u32>,    // commodity_key -> addiction level
    pub game_over: bool,
    pub game_over_reason: Option<String>,
}

#[derive(Debug, Clone, Serialize, Deserialize, Default)]
pub struct WeaponSlots {
    pub melee: Option<String>,              // weapon_key
    pub gun: Option<String>,                // weapon_key
}

#[derive(Debug, Clone, Serialize, Deserialize, Default)]
pub struct QuestProgress {
    pub story_step: u32,                    // 0-15 (0 = not started)
    pub active_deliveries: Vec<DeliveryQuest>,
    pub completed_deliveries: u32,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct DeliveryQuest {
    pub id: String,
    pub commodity: String,
    pub quantity: u32,
    pub from_location: String,
    pub to_location: String,
    pub reward: i64,
    pub expires_day: u32,
}

#[derive(Debug, Clone, Serialize, Deserialize, Default)]
pub struct GameStats {
    pub total_bought: i64,
    pub total_sold: i64,
    pub total_profit: i64,
    pub police_encounters: u32,
    pub muggings_survived: u32,
    pub people_killed: u32,
    pub hospital_visits: u32,
    pub max_net_worth: i64,
}

impl GameState {
    pub fn new() -> Self {
        let mut gang_relations = HashMap::new();
        gang_relations.insert("triads".to_string(), 0);
        gang_relations.insert("cartel".to_string(), 0);
        gang_relations.insert("mafia".to_string(), 0);

        Self {
            day: 1,
            actions_remaining: 5,
            location: "bronx".to_string(),
            city: "nyc".to_string(),
            cash: 200000,  // $2,000 in cents
            bank_balance: 0,
            bank_unlocked: false,
            mattress_stash: 0,
            debt: 550000,  // $5,500 in cents
            health: 100,
            max_health: 100,
            notoriety: 0,
            inventory: HashMap::new(),
            coat_tier: 0,  // 100 units capacity
            weapons: WeaponSlots::default(),
            gang_relations,
            quest_state: QuestProgress::default(),
            stats: GameStats::default(),
            addiction: HashMap::new(),
            game_over: false,
            game_over_reason: None,
        }
    }

    /// Get coat capacity based on tier
    pub fn coat_capacity(&self) -> u32 {
        match self.coat_tier {
            0 => 100,
            1 => 125,
            2 => 150,
            _ => 250,
        }
    }

    /// Get current inventory count
    pub fn inventory_count(&self) -> u32 {
        self.inventory.values().sum()
    }

    /// Calculate net worth (cash + bank + stash + inventory value - debt)
    pub fn net_worth(&self, prices: &HashMap<String, i64>) -> i64 {
        let inventory_value: i64 = self.inventory.iter()
            .map(|(k, &v)| prices.get(k).unwrap_or(&0) * (v as i64))
            .sum();
        self.cash + self.bank_balance + self.mattress_stash + inventory_value - self.debt
    }

    /// Apply daily interest to debt (10% = 1000 basis points)
    pub fn apply_debt_interest(&mut self) {
        // (debt * 11000) / 10000 = debt * 1.10
        self.debt = (self.debt * 11000) / 10000;
    }

    /// Apply daily interest to bank (5% = 500 basis points)
    pub fn apply_bank_interest(&mut self) {
        if self.bank_unlocked {
            // (balance * 10500) / 10000 = balance * 1.05
            self.bank_balance = (self.bank_balance * 10500) / 10000;
        }
    }

    /// Decay notoriety by 10% (laying low)
    pub fn decay_notoriety(&mut self) {
        self.notoriety = (self.notoriety * 90) / 100;
    }
}
```

Update backend/src/lib.rs to add `pub mod game;`
  </action>
  <verify>
Run `cargo check` - compiles without errors.
  </verify>
  <done>
GameState struct with all fields exists.
Serde derives enable JSON serialization.
Helper methods for capacity, net worth, interest calculations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create static game data definitions</name>
  <files>backend/src/game/data.rs</files>
  <action>
Create backend/src/game/data.rs with static game content:

```rust
use std::collections::HashMap;

/// City with boroughs
#[derive(Debug, Clone)]
pub struct City {
    pub key: &'static str,
    pub name: &'static str,
    pub boroughs: &'static [Borough],
    pub has_casino: bool,
}

#[derive(Debug, Clone)]
pub struct Borough {
    pub key: &'static str,
    pub name: &'static str,
    pub gang_territory: Option<&'static str>,
    pub has_hospital: bool,
    pub has_gun_shop: bool,
    pub has_mob_doctor: bool,
}

/// Commodity (drug) with price ranges
#[derive(Debug, Clone)]
pub struct Commodity {
    pub key: &'static str,
    pub name: &'static str,
    pub min_price: i64,      // In cents
    pub max_price: i64,
    pub addictive: bool,     // Can cause addiction
    pub action_boost: bool,  // Grants extra actions
}

/// Weapon definition
#[derive(Debug, Clone)]
pub struct Weapon {
    pub key: &'static str,
    pub name: &'static str,
    pub damage: u32,
    pub price: i64,          // In cents
    pub is_gun: bool,        // false = melee
}

/// Gang definition
#[derive(Debug, Clone)]
pub struct Gang {
    pub key: &'static str,
    pub name: &'static str,
    pub tribute_cost: i64,   // Cost to buy favor
}

// ============================================================================
// STATIC DATA
// ============================================================================

pub static CITIES: &[City] = &[
    City {
        key: "nyc",
        name: "New York City",
        boroughs: &[
            Borough { key: "bronx", name: "The Bronx", gang_territory: None, has_hospital: true, has_gun_shop: true, has_mob_doctor: false },
            Borough { key: "brooklyn", name: "Brooklyn", gang_territory: Some("mafia"), has_hospital: false, has_gun_shop: false, has_mob_doctor: true },
            Borough { key: "manhattan", name: "Manhattan", gang_territory: None, has_hospital: true, has_gun_shop: true, has_mob_doctor: false },
            Borough { key: "queens", name: "Queens", gang_territory: Some("triads"), has_hospital: false, has_gun_shop: false, has_mob_doctor: false },
        ],
        has_casino: true,
    },
    City {
        key: "miami",
        name: "Miami",
        boroughs: &[
            Borough { key: "little_havana", name: "Little Havana", gang_territory: Some("cartel"), has_hospital: false, has_gun_shop: true, has_mob_doctor: true },
            Borough { key: "south_beach", name: "South Beach", gang_territory: None, has_hospital: true, has_gun_shop: false, has_mob_doctor: false },
            Borough { key: "downtown_miami", name: "Downtown", gang_territory: None, has_hospital: true, has_gun_shop: true, has_mob_doctor: false },
        ],
        has_casino: true,
    },
    City {
        key: "london",
        name: "London",
        boroughs: &[
            Borough { key: "east_end", name: "East End", gang_territory: Some("mafia"), has_hospital: false, has_gun_shop: false, has_mob_doctor: true },
            Borough { key: "soho", name: "Soho", gang_territory: None, has_hospital: true, has_gun_shop: false, has_mob_doctor: false },
            Borough { key: "brixton", name: "Brixton", gang_territory: None, has_hospital: false, has_gun_shop: true, has_mob_doctor: false },
        ],
        has_casino: false,
    },
    City {
        key: "tokyo",
        name: "Tokyo",
        boroughs: &[
            Borough { key: "shinjuku", name: "Shinjuku", gang_territory: Some("triads"), has_hospital: false, has_gun_shop: true, has_mob_doctor: true },
            Borough { key: "shibuya", name: "Shibuya", gang_territory: None, has_hospital: true, has_gun_shop: false, has_mob_doctor: false },
            Borough { key: "roppongi", name: "Roppongi", gang_territory: None, has_hospital: false, has_gun_shop: false, has_mob_doctor: false },
        ],
        has_casino: true,
    },
    City {
        key: "bogota",
        name: "Bogota",
        boroughs: &[
            Borough { key: "chapinero", name: "Chapinero", gang_territory: Some("cartel"), has_hospital: true, has_gun_shop: true, has_mob_doctor: true },
            Borough { key: "la_candelaria", name: "La Candelaria", gang_territory: Some("cartel"), has_hospital: false, has_gun_shop: true, has_mob_doctor: false },
            Borough { key: "usaquen", name: "Usaquen", gang_territory: None, has_hospital: true, has_gun_shop: false, has_mob_doctor: false },
        ],
        has_casino: false,
    },
];

pub static COMMODITIES: &[Commodity] = &[
    // Classic drugs
    Commodity { key: "cocaine", name: "Cocaine", min_price: 1500000, max_price: 3000000, addictive: true, action_boost: false },
    Commodity { key: "heroin", name: "Heroin", min_price: 500000, max_price: 1400000, addictive: true, action_boost: false },
    Commodity { key: "acid", name: "Acid", min_price: 100000, max_price: 450000, addictive: false, action_boost: false },
    Commodity { key: "weed", name: "Weed", min_price: 30000, max_price: 90000, addictive: false, action_boost: false },
    Commodity { key: "meth", name: "Meth", min_price: 200000, max_price: 550000, addictive: true, action_boost: true },
    Commodity { key: "speed", name: "Speed", min_price: 9000, max_price: 25000, addictive: true, action_boost: true },
    Commodity { key: "ludes", name: "Ludes", min_price: 1100, max_price: 6000, addictive: false, action_boost: false },
    // Modern additions
    Commodity { key: "fentanyl", name: "Fentanyl", min_price: 3000000, max_price: 8000000, addictive: true, action_boost: false },
    Commodity { key: "bathsalts", name: "Bath Salts", min_price: 50000, max_price: 150000, addictive: true, action_boost: true },
    Commodity { key: "krokodil", name: "Krokodil", min_price: 10000, max_price: 40000, addictive: true, action_boost: false },
    Commodity { key: "tidepods", name: "Tide Pods", min_price: 500, max_price: 2000, addictive: false, action_boost: false },
];

pub static WEAPONS: &[Weapon] = &[
    // Melee weapons
    Weapon { key: "knuckles", name: "Brass Knuckles", damage: 5, price: 5000, is_gun: false },
    Weapon { key: "knife", name: "Switchblade", damage: 10, price: 15000, is_gun: false },
    Weapon { key: "pipe", name: "Lead Pipe", damage: 15, price: 8000, is_gun: false },
    Weapon { key: "machete", name: "Machete", damage: 25, price: 35000, is_gun: false },
    // Guns
    Weapon { key: "glock", name: "Glock 19", damage: 20, price: 50000, is_gun: true },
    Weapon { key: "revolver", name: "Six Shooter", damage: 25, price: 40000, is_gun: true },
    Weapon { key: "deagle", name: "Desert Eagle", damage: 35, price: 100000, is_gun: true },
    Weapon { key: "shotgun", name: "Shotgun", damage: 45, price: 80000, is_gun: true },
    Weapon { key: "uzi", name: "Uzi", damage: 40, price: 150000, is_gun: true },
    Weapon { key: "ak47", name: "AK-47", damage: 55, price: 250000, is_gun: true },
    Weapon { key: "m16", name: "M16", damage: 60, price: 300000, is_gun: true },
    Weapon { key: "gatling", name: "Gatling Gun", damage: 100, price: 1000000, is_gun: true },
];

pub static GANGS: &[Gang] = &[
    Gang { key: "triads", name: "The Triads", tribute_cost: 500000 },
    Gang { key: "cartel", name: "The Cartel", tribute_cost: 750000 },
    Gang { key: "mafia", name: "The Mafia", tribute_cost: 600000 },
];

// ============================================================================
// LOOKUP FUNCTIONS
// ============================================================================

pub fn get_city(key: &str) -> Option<&'static City> {
    CITIES.iter().find(|c| c.key == key)
}

pub fn get_borough(city_key: &str, borough_key: &str) -> Option<&'static Borough> {
    get_city(city_key)?.boroughs.iter().find(|b| b.key == borough_key)
}

pub fn get_commodity(key: &str) -> Option<&'static Commodity> {
    COMMODITIES.iter().find(|c| c.key == key)
}

pub fn get_weapon(key: &str) -> Option<&'static Weapon> {
    WEAPONS.iter().find(|w| w.key == key)
}

pub fn get_gang(key: &str) -> Option<&'static Gang> {
    GANGS.iter().find(|g| g.key == key)
}

/// Get travel cost between cities (in cents)
pub fn get_travel_cost(from_city: &str, to_city: &str, mode: TravelMode) -> (i64, u32) {
    if from_city == to_city {
        // Intra-city taxi fare, instant
        return (2000, 0); // $20, 0 days
    }

    // Inter-city travel costs money and time
    match mode {
        TravelMode::Bus => (10000, 1),      // $100, 1 day
        TravelMode::Plane => (50000, 0),    // $500, instant
    }
}

#[derive(Debug, Clone, Copy)]
pub enum TravelMode {
    Bus,
    Plane,
}

/// Get coat tier upgrade cost and what trenchcoat guy might want
pub fn get_coat_upgrade_cost(current_tier: u32) -> Option<i64> {
    match current_tier {
        0 => Some(50000),   // $500 for tier 1
        1 => Some(100000),  // $1000 for tier 2
        2 => Some(250000),  // $2500 for tier 3
        _ => None,          // Already max tier
    }
}
```
  </action>
  <verify>
Run `cargo check` - compiles without errors.
  </verify>
  <done>
Static data for cities, boroughs, commodities, weapons, gangs defined.
Lookup functions for accessing data by key.
Travel cost calculations available.
  </done>
</task>

</tasks>

<verification>
Run `cargo check && cargo test` - all pass.
GameState::new() creates valid initial state.
Static data is accessible via lookup functions.
</verification>

<success_criteria>
- GameState serializes/deserializes cleanly with serde_json
- All game data defined (5 cities, ~20 boroughs, 11 commodities, 12 weapons, 3 gangs)
- Helper functions for coat capacity, net worth, interest calculations
- Travel costs defined for inter/intra-city travel
</success_criteria>

<output>
After completion, create `.planning/phases/08-first-door-game-drug-wars/08-02-SUMMARY.md`
</output>
