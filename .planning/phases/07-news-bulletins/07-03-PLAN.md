---
phase: 07-news-bulletins
plan: 03
type: execute
wave: 3
depends_on: ["07-02"]
files_modified:
  - backend/src/websocket/session.rs
  - config.toml
autonomous: true

must_haves:
  truths:
    - "User can access news via N hotkey from main menu"
    - "User sees loading message while feeds are being fetched"
    - "User can navigate list with arrow keys or N/P"
    - "User can select article with Enter and return with Q"
    - "User can quit back to main menu from news list"
  artifacts:
    - path: "backend/src/websocket/session.rs"
      provides: "News command handling and input routing"
      contains: "handle_news_input"
    - path: "config.toml"
      provides: "News command in main menu"
      contains: 'command = "news"'
  key_links:
    - from: "backend/src/websocket/session.rs"
      to: "crate::services::news"
      via: "news render and fetch functions"
      pattern: "news::"
    - from: "backend/src/websocket/session.rs"
      to: "NewsState"
      via: "session state field"
      pattern: "news_state"
---

<objective>
Wire news into session lifecycle with input handling and menu integration

Purpose: Enable users to access and navigate news from the main menu
Output: Fully functional news feature accessible via N hotkey with keyboard navigation
</objective>

<execution_context>
@C:\Users\chris\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\chris\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-news-bulletins/07-CONTEXT.md
@.planning/phases/07-news-bulletins/07-RESEARCH.md
@backend/src/websocket/session.rs
@backend/src/menu/state.rs
@config.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update config.toml menu to use news as command</name>
  <files>config.toml</files>
  <action>
The current config.toml has News as a submenu. Per user decision, news should be accessed via N hotkey directly (like M for mail, C for chat).

Update the [[menu.main]] entry for News from submenu to command type:

Change from:
```toml
[[menu.main]]
type = "submenu"
hotkey = "N"
name = "News & Bulletins"
submenu_key = "news"
order = 4
```

To:
```toml
[[menu.main]]
type = "command"
hotkey = "N"
name = "News"
command = "news"
order = 4
```

This matches the pattern used for mail (M -> "mail") and chat (C -> "chat").
  </action>
  <verify>Read config.toml and verify the menu entry is type = "command" with command = "news"</verify>
  <done>News menu entry changed from submenu to direct command</done>
</task>

<task type="auto">
  <name>Task 2: Add news state and input handling to session.rs</name>
  <files>backend/src/websocket/session.rs</files>
  <action>
1. Add import at the top of session.rs:
   ```rust
   use crate::services::news::{
       fetch_feeds, render_news_list, render_news_article,
       render_news_loading, render_news_errors, NewsState,
   };
   ```

2. Add news_state field to Session struct:
   ```rust
   /// Current news viewing state
   news_state: Option<NewsState>,
   ```

3. Initialize in Session::new():
   ```rust
   news_state: None,
   ```

4. Add the "__news__" sentinel to the handle_authenticated_input match for current_service.
   Look for the pattern used by "__mail_inbox__", "__chat__", etc.

   In the match on self.current_service, add a branch:
   ```rust
   Some(ref svc) if svc == "__news__" => {
       self.handle_news_input(input).await;
       return;
   }
   ```

5. Add MenuAction::ExecuteCommand handling for "news" command.
   Find where "mail" and "chat" commands are handled in the menu action match.
   Add similar handling for "news":
   ```rust
   "news" => {
       // Show loading screen
       let loading = render_news_loading();
       let _ = self.tx.send(loading).await;

       // Fetch feeds
       let feeds = &self.state.config.news.feeds;
       let result = fetch_feeds(feeds).await;

       // Create state and show list
       let state = NewsState::new(result);
       if state.articles.is_empty() && !state.errors.is_empty() {
           // All feeds failed
           let error_screen = render_news_errors(&state.errors);
           let _ = self.tx.send(error_screen).await;
           // Wait for any key to return
           self.news_state = Some(state);
           self.current_service = Some("__news_error__".to_string());
       } else {
           let list = render_news_list(&state);
           let _ = self.tx.send(list).await;
           self.news_state = Some(state);
           self.current_service = Some("__news__".to_string());
       }
   }
   ```

6. Add handler for "__news_error__" sentinel (any key returns to menu):
   ```rust
   Some(ref svc) if svc == "__news_error__" => {
       // Any input returns to menu
       self.news_state = None;
       self.current_service = None;
       self.show_main_menu().await;
       return;
   }
   ```

7. Create the handle_news_input method:
   ```rust
   /// Handle input while in news view
   async fn handle_news_input(&mut self, input: &str) {
       let Some(ref mut state) = self.news_state else {
           // No state, return to menu
           self.current_service = None;
           self.show_main_menu().await;
           return;
       };

       // Check for escape sequences (arrow keys)
       // Up arrow: \x1b[A or \x1bOA
       // Down arrow: \x1b[B or \x1bOB
       let is_up = input == "\x1b[A" || input == "\x1bOA";
       let is_down = input == "\x1b[B" || input == "\x1bOB";

       if state.viewing_article {
           // Article view mode
           match input.to_uppercase().as_str() {
               "Q" => {
                   // Return to list
                   state.exit_article();
                   let list = render_news_list(state);
                   let _ = self.tx.send(list).await;
               }
               "N" => {
                   // Next article
                   state.select_next();
                   if let Some(article) = state.current_article() {
                       let view = render_news_article(article);
                       let _ = self.tx.send(view).await;
                   }
               }
               "P" => {
                   // Previous article
                   state.select_prev();
                   if let Some(article) = state.current_article() {
                       let view = render_news_article(article);
                       let _ = self.tx.send(view).await;
                   }
               }
               _ => {} // Ignore other input
           }
       } else {
           // List view mode
           if is_up {
               state.select_prev();
               let list = render_news_list(state);
               let _ = self.tx.send(list).await;
           } else if is_down {
               state.select_next();
               let list = render_news_list(state);
               let _ = self.tx.send(list).await;
           } else {
               match input.to_uppercase().as_str() {
                   "Q" => {
                       // Quit to main menu
                       self.news_state = None;
                       self.current_service = None;
                       self.show_main_menu().await;
                   }
                   "\r" | "\n" => {
                       // Enter - view selected article
                       if state.has_articles() {
                           state.enter_article();
                           if let Some(article) = state.current_article() {
                               let view = render_news_article(article);
                               let _ = self.tx.send(view).await;
                           }
                       }
                   }
                   "N" => {
                       // Next page
                       let page_size = 15;
                       if state.page_offset + page_size < state.articles.len() {
                           state.page_offset += page_size;
                           state.selected_idx = state.page_offset;
                           let list = render_news_list(state);
                           let _ = self.tx.send(list).await;
                       }
                   }
                   "P" => {
                       // Previous page
                       let page_size = 15;
                       if state.page_offset >= page_size {
                           state.page_offset -= page_size;
                           state.selected_idx = state.page_offset;
                           let list = render_news_list(state);
                           let _ = self.tx.send(list).await;
                       }
                   }
                   _ => {} // Ignore other input
               }
           }
       }
   }
   ```

Note: The exact placement and integration will depend on the existing session.rs structure. Follow the patterns used for mail and chat sentinel services.
  </action>
  <verify>Run `cd C:/Git/bbs/backend && cargo check` - should compile without errors</verify>
  <done>News command handling integrated into session with arrow key navigation and article viewing</done>
</task>

<task type="auto">
  <name>Task 3: Test news feature end-to-end</name>
  <files>None (verification only)</files>
  <action>
Start the BBS and verify news functionality:

1. Start the backend: `cd C:/Git/bbs/backend && cargo run`
2. Open browser to http://localhost:3000
3. Log in with an existing user (or create new account)
4. Press N at main menu
5. Verify:
   - Loading message appears briefly
   - News list shows with THE WIRE header
   - Articles are grouped by source (Hacker News, Ars Technica)
   - Arrow keys move selection (highlighted item changes)
   - Enter opens article view
   - Q in article view returns to list
   - Q in list view returns to main menu
   - N/P pages through if more than 15 articles

If any feeds fail, verify error handling shows user-friendly message.
  </action>
  <verify>Manual testing confirms news feature works: loading screen appears, list navigation works with arrow keys and N/P, article view works, Q exits properly</verify>
  <done>News feature fully functional with list navigation and article viewing</done>
</task>

</tasks>

<verification>
1. `cd C:/Git/bbs/backend && cargo check` passes
2. N hotkey at main menu opens news
3. Arrow keys navigate list (selection highlight moves)
4. Enter opens article, Q returns to list
5. Q from list returns to main menu
6. Feed errors display user-friendly messages
</verification>

<success_criteria>
- News accessible via N hotkey from main menu
- Loading screen shows while fetching feeds
- List displays articles grouped by source
- Arrow key navigation works (up/down)
- N/P page navigation works
- Enter selects article for full view
- Q exits from both article and list views
- Feed errors handled gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/07-news-bulletins/07-03-SUMMARY.md`
</output>
