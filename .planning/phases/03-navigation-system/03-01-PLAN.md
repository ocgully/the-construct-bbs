---
phase: 03-navigation-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/menu/mod.rs
  - backend/src/menu/config.rs
  - backend/src/menu/quotes.rs
  - backend/src/config.rs
  - config.toml
  - backend/Cargo.toml
autonomous: true

must_haves:
  truths:
    - "Menu items are defined in config.toml with type, hotkey, name, order, and min_level"
    - "Config includes main menu items (submenus, Profile command, Quit command)"
    - "Config includes submenu items (Games, Mail, Chat, News) with commented-out future services"
    - "Stoic quotes are embedded and randomly selectable"
  artifacts:
    - path: "backend/src/menu/config.rs"
      provides: "MenuItem enum with Service/Submenu/Command variants, MenuConfig struct"
      exports: ["MenuItem", "MenuConfig"]
    - path: "backend/src/menu/quotes.rs"
      provides: "Stoic quote array and random selection function"
      exports: ["random_stoic_quote"]
    - path: "backend/src/menu/mod.rs"
      provides: "Menu module public API"
    - path: "backend/src/config.rs"
      provides: "MenuConfig section added to Config struct"
      contains: "menu"
    - path: "config.toml"
      provides: "Complete menu configuration with main menu + submenus"
      contains: "[[menu.main]]"
  key_links:
    - from: "backend/src/config.rs"
      to: "backend/src/menu/config.rs"
      via: "MenuConfig type used in Config struct"
      pattern: "menu.*MenuConfig"
    - from: "config.toml"
      to: "backend/src/menu/config.rs"
      via: "TOML deserialization via serde"
      pattern: "menu\\.main"
---

<objective>
Create the menu configuration schema, TOML menu definitions, and Stoic quote module.

Purpose: Establishes the data layer for the entire navigation system -- config-driven menu definitions that the sysop can edit, plus the MOTD quote rotation mechanism.
Output: Menu config types, populated config.toml with all menu entries, and embedded Stoic quotes with random selection.
</objective>

<execution_context>
@C:\Users\chris\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\chris\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-navigation-system/03-CONTEXT.md
@.planning/phases/03-navigation-system/03-RESEARCH.md
@backend/src/config.rs
@backend/Cargo.toml
@config.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Menu config schema and TOML menu definitions</name>
  <files>
    backend/src/menu/mod.rs
    backend/src/menu/config.rs
    backend/src/config.rs
    config.toml
  </files>
  <action>
Create the `backend/src/menu/` module directory with `mod.rs` and `config.rs`.

**backend/src/menu/config.rs:**
Define the MenuItem enum with internally-tagged serde deserialization:
```rust
#[derive(Debug, Clone, Deserialize)]
#[serde(tag = "type", rename_all = "lowercase")]
pub enum MenuItem {
    Service {
        hotkey: String,   // Single char as string for TOML compat
        name: String,
        service_name: String,
        #[serde(default)]
        min_level: u8,
        #[serde(default)]
        order: i32,
    },
    Submenu {
        hotkey: String,
        name: String,
        submenu_key: String,
        #[serde(default)]
        min_level: u8,
        #[serde(default)]
        order: i32,
    },
    Command {
        hotkey: String,
        name: String,
        command: String,  // "quit", "profile", "help"
        #[serde(default)]
        min_level: u8,
        #[serde(default)]
        order: i32,
    },
}
```

Add helper methods on MenuItem:
- `hotkey(&self) -> &str` -- returns the hotkey string
- `name(&self) -> &str` -- returns the display name
- `order(&self) -> i32` -- returns the sort order
- `min_level(&self) -> u8` -- returns the minimum user level
- `matches_key(&self, key: char) -> bool` -- case-insensitive hotkey match using eq_ignore_ascii_case

Define MenuConfig struct:
```rust
#[derive(Debug, Clone, Deserialize, Default)]
pub struct MenuConfig {
    #[serde(default)]
    pub main: Vec<MenuItem>,
    #[serde(default)]
    pub games: Vec<MenuItem>,
    #[serde(default)]
    pub mail: Vec<MenuItem>,
    #[serde(default)]
    pub chat: Vec<MenuItem>,
    #[serde(default)]
    pub news: Vec<MenuItem>,
}
```

Add helper methods on MenuConfig:
- `main_items(&self, user_level: u8) -> Vec<&MenuItem>` -- filters by min_level, sorts by order
- `submenu_items(&self, key: &str, user_level: u8) -> Vec<&MenuItem>` -- returns items for a submenu key, filtered and sorted
- `submenu_name(&self, key: &str) -> &str` -- returns human name for submenu key ("games" -> "Games")

**backend/src/menu/mod.rs:**
```rust
pub mod config;
pub mod quotes;
pub use config::{MenuItem, MenuConfig};
pub use quotes::random_stoic_quote;
```

**backend/src/config.rs:**
Add `menu` field to Config struct with `#[serde(default)]`:
```rust
#[serde(default)]
pub menu: MenuConfig,
```
Import MenuConfig from the menu module. Add `mod menu;` to main.rs.

**config.toml:**
Add complete menu configuration after the [connection] section:

Main menu items (ordered):
1. `type = "submenu"`, hotkey = "G", name = "Games", submenu_key = "games", order = 1
2. `type = "submenu"`, hotkey = "M", name = "Mail", submenu_key = "mail", order = 2
3. `type = "submenu"`, hotkey = "C", name = "Chat", submenu_key = "chat", order = 3
4. `type = "submenu"`, hotkey = "N", name = "News & Bulletins", submenu_key = "news", order = 4
5. `type = "command"`, hotkey = "P", name = "Profile", command = "profile", order = 90
6. `type = "command"`, hotkey = "Q", name = "Quit", command = "quit", order = 100

Games submenu (with commented-out future items):
- Comment header: "# Games submenu -- items appear when their phase ships"
- All items commented out with descriptive comments:
  ```
  # [[menu.games]]
  # type = "service"
  # hotkey = "1"
  # name = "Drug Wars"
  # service_name = "drug_wars"
  # order = 1
  # Phase 8: Commodity trading game
  ```
  Similarly for LORD (Phase 9), Usurper (Phase 10), Acrophobia (Phase 11), Kyrandia MUD (Phase 12).

Mail submenu: All commented out (Phase 5)
Chat submenu: All commented out (Phase 6)
News submenu: All commented out (Phase 7)

Important: Use `Serialize` and `Deserialize` on all types. Use `#[serde(default)]` on all Vec fields and the MenuConfig struct itself so the [menu] section is entirely optional in config.toml.
  </action>
  <verify>
Run `cargo build` from backend/ directory. The build must succeed with the new menu module and updated config.
Run `cargo test` to ensure existing tests still pass.
Manually verify config.toml parses correctly by checking the startup log (cargo run should not error on config load).
  </verify>
  <done>
MenuItem enum deserializes from TOML with type/hotkey/name/order/min_level fields. MenuConfig provides filtered, sorted item access. Config struct includes menu field. config.toml has complete menu definitions with all future items commented out.
  </done>
</task>

<task type="auto">
  <name>Task 2: Stoic quotes module with random selection</name>
  <files>
    backend/src/menu/quotes.rs
  </files>
  <action>
Create `backend/src/menu/quotes.rs` with:

1. An embedded array of 20-30 Stoic/Stoicism quotes. Use `const STOIC_QUOTES: &[&str]`. Include quotes from:
   - Marcus Aurelius (Meditations) -- ~10 quotes
   - Seneca (Letters, On the Shortness of Life) -- ~8 quotes
   - Epictetus (Discourses, Enchiridion) -- ~5 quotes
   - Misc classical Stoics -- 2-3 quotes

   Keep quotes brief (under 100 chars each) for the MOTD area. Format: "Quote text. -- Author"

2. `pub fn random_stoic_quote() -> &'static str` function using `rand::seq::SliceRandom` trait (rand 0.8 API):
   ```rust
   use rand::seq::SliceRandom;
   use rand::thread_rng;

   pub fn random_stoic_quote() -> &'static str {
       let mut rng = thread_rng();
       STOIC_QUOTES.choose(&mut rng).unwrap_or(&STOIC_QUOTES[0])
   }
   ```

Note: rand 0.8 uses `thread_rng()` and `SliceRandom` trait (NOT rand 0.9 API). The existing Cargo.toml has `rand = "0.8"`. Do NOT upgrade to 0.9.
  </action>
  <verify>
Add a simple test in the file:
```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_random_quote_returns_nonempty() {
        let quote = random_stoic_quote();
        assert!(!quote.is_empty());
        assert!(quote.contains("--"));
    }

    #[test]
    fn test_quotes_array_not_empty() {
        assert!(STOIC_QUOTES.len() >= 20);
    }
}
```
Run `cargo test` -- both tests must pass.
  </verify>
  <done>
quotes.rs contains 20+ embedded Stoic quotes and a random_stoic_quote() function. Tests verify the quotes array is populated and selection returns a valid, non-empty quote with author attribution.
  </done>
</task>

</tasks>

<verification>
1. `cargo build` succeeds with menu module, config schema, and quotes
2. `cargo test` passes (existing tests + new quotes tests)
3. Config loads without errors when running the server
4. MenuItem enum correctly uses internally-tagged serde
5. MenuConfig provides level-filtered, order-sorted item access
</verification>

<success_criteria>
- Menu config types compile and deserialize from TOML
- config.toml has complete menu hierarchy (main + 4 submenus with commented future items)
- 20+ Stoic quotes embedded with random selection working
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-navigation-system/03-01-SUMMARY.md`
</output>
