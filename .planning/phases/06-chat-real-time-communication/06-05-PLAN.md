---
phase: 06-chat-real-time-communication
plan: 05
type: execute
wave: 3
depends_on: ["06-03", "06-04"]
files_modified:
  - backend/src/websocket/session.rs
  - backend/config.toml
autonomous: true

must_haves:
  truths:
    - "User can access chat from main menu via C hotkey"
    - "User can view who's online from chat via /who"
    - "Chat menu item appears in main menu"
  artifacts:
    - path: "backend/config.toml"
      provides: "Chat menu item configuration"
      contains: "Chat"
  key_links:
    - from: "backend/src/websocket/session.rs"
      to: "enter_chat"
      via: "MenuAction::ExecuteCommand(chat)"
      pattern: 'ExecuteCommand.*"chat".*enter_chat'
---

<objective>
Add chat to main menu and wire ExecuteCommand routing.

Purpose: Make chat accessible from the main menu, completing the user-facing integration.
Output: Chat menu item, command routing in session.rs, working end-to-end chat flow.
</objective>

<execution_context>
@C:\Users\chris\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\chris\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-chat-real-time-communication/06-CONTEXT.md
@.planning/phases/06-chat-real-time-communication/06-RESEARCH.md
@.planning/phases/06-chat-real-time-communication/06-03-SUMMARY.md
@.planning/phases/06-chat-real-time-communication/06-04-SUMMARY.md

Relevant existing code:
@backend/config.toml — menu configuration
@backend/src/websocket/session.rs — MenuAction::ExecuteCommand handling
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add chat menu item to config.toml</name>
  <files>backend/config.toml</files>
  <action>
In the `[menu]` section, find the `main_menu` array and add a chat entry.

Looking at the existing structure, add after the mail entry (M) and before any games:

```toml
{ type = "command", hotkey = "C", name = "Chat", command = "chat", order = 4, min_level = 0 },
```

Adjust the order number to fit between existing items. The key points:
- type = "command" (not submenu or service)
- hotkey = "C"
- command = "chat" (this is what session.rs will match)
- min_level = 0 (all users can access)

Check the current config.toml structure first to determine correct placement.
  </action>
  <verify>Server starts without config parse errors</verify>
  <done>Chat menu item appears in main menu config</done>
</task>

<task type="auto">
  <name>Task 2: Wire chat command in session.rs</name>
  <files>backend/src/websocket/session.rs</files>
  <action>
1. In `handle_authenticated_input`, find the `MenuAction::ExecuteCommand(cmd)` match block.

There are TWO places that handle ExecuteCommand:
- In the single-char processing loop (process_key)
- In process_typeahead

Add chat command handling to BOTH places.

In the first block (around line 1234), find the match on cmd.as_str():
```rust
MenuAction::ExecuteCommand(cmd) => {
    match cmd.as_str() {
        "quit" => {
            // ... quit handling
        }
        "whos_online" => {
            // ... who's online handling
        }
        // ... other commands
```

Add a new arm:
```rust
        "chat" => {
            let _ = self.tx.send(format!("{}\r\n", ch)).await;
            self.enter_chat().await;
            return;
        }
```

2. In `process_typeahead` (around line 1312), find the similar match:
```rust
MenuAction::ExecuteCommand(cmd) => {
    match cmd.as_str() {
        "quit" => { self.handle_quit().await; return; }
        // ...
```

Add:
```rust
        "chat" => { self.enter_chat().await; return; }
```

The pattern matches how "mail" is handled in both places.
  </action>
  <verify>cargo build --manifest-path backend/Cargo.toml</verify>
  <done>Chat command routes to enter_chat in both ExecuteCommand handlers</done>
</task>

<task type="auto">
  <name>Task 3: Verify /who shows participants (not just online users)</name>
  <files>backend/src/websocket/session.rs</files>
  <action>
The /who command in chat should show users IN CHAT, not all online users.

Verify that handle_chat_input uses chat_manager.get_participants() (not node_manager):

In handle_chat_input, the Who command handler should be:
```rust
ChatCommand::Who => {
    let participants = self.state.chat_manager.get_participants().await;
    let _ = self.tx.send(render_chat_who(&participants)).await;
}
```

This is already correct in plan 03.

Also verify that render_chat_who header says "Users in chat" not "Users online".
  </action>
  <verify>Review code to confirm correct usage</verify>
  <done>/who shows chat participants correctly</done>
</task>

</tasks>

<verification>
1. `cargo build --manifest-path backend/Cargo.toml` succeeds
2. Server starts and shows main menu with Chat option
3. Manual test: Press C from main menu, enter chat
4. Manual test: Type message, see it appear
5. Manual test: Open second browser, enter chat, see join announcement in first
6. Manual test: /who shows both users
7. Manual test: /quit returns to main menu
8. Manual test: /page user triggers bell in other browser
9. Manual test: /msg user message sends DM visible only to sender and recipient
</verification>

<success_criteria>
- Chat appears in main menu (C hotkey)
- Pressing C enters chat mode
- All chat features work end-to-end
- /who shows chat participants only
- Phase 6 requirements CHAT-01 through CHAT-06 all met
</success_criteria>

<output>
After completion, create `.planning/phases/06-chat-real-time-communication/06-05-SUMMARY.md`
</output>
