---
phase: 02-authentication-connection
plan: 06
type: execute
wave: 5
depends_on: ["02-05"]
files_modified:
  - backend/src/services/profile.rs
  - backend/src/services/goodbye.rs
  - backend/src/services/mod.rs
  - backend/src/db/user.rs
  - backend/src/websocket/session.rs
autonomous: true

must_haves:
  truths:
    - "User can view their profile with handle, join date, location, signature, and stats"
    - "User profile displays as ANSI art card with box-drawing borders"
    - "User sees goodbye screen with session stats on logout"
    - "Session time is tracked and added to total_time_minutes on logout"
    - "Goodbye screen shows time online, total calls, and farewell ANSI art"
  artifacts:
    - path: "backend/src/services/profile.rs"
      provides: "User profile display as ANSI art card"
      exports: ["render_profile_card"]
    - path: "backend/src/services/goodbye.rs"
      provides: "Goodbye sequence with session stats"
      exports: ["render_goodbye"]
  key_links:
    - from: "backend/src/services/profile.rs"
      to: "backend/src/db/user.rs"
      via: "find_user_by_id for profile data"
      pattern: "find_user_by_id"
    - from: "backend/src/services/goodbye.rs"
      to: "backend/src/db/user.rs"
      via: "update_user_time on logout"
      pattern: "update_user_time"
    - from: "backend/src/websocket/session.rs"
      to: "backend/src/services/goodbye.rs"
      via: "on_disconnect triggers goodbye"
      pattern: "render_goodbye"
---

<objective>
Implement user profile display as an ANSI art card and the goodbye sequence with session stats tracking.

Purpose: User identity is a core BBS concept -- seeing your profile card with stats gives a sense of ownership. The goodbye sequence provides closure and reinforces the "logging off" feeling, while tracking session time for stats.

Output: Profile card rendered as ANSI art with all user fields and stats. Goodbye screen shows session duration, total calls, and farewell art. Session time tracked in database.
</objective>

<execution_context>
@C:\Users\chris\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\chris\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-authentication-connection/02-CONTEXT.md

@backend/src/services/mod.rs
@backend/src/db/user.rs
@backend/src/websocket/session.rs
@backend/src/terminal/ansi.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: User profile ANSI art card</name>
  <files>
    backend/src/services/profile.rs
    backend/src/services/mod.rs
    backend/src/db/user.rs
  </files>
  <action>
1. Create `backend/src/services/profile.rs`:

   - `pub fn render_profile_card(user: &User, is_own_profile: bool) -> String`:
     Renders a box-drawn ANSI profile card. Use AnsiWriter to build it.

     Layout (80 chars wide):
     ```
     ╔══════════════════════════════════════════════════════════════════════════════╗
     ║  USER PROFILE                                                    [Sysop]  ║
     ╠══════════════════════════════════════════════════════════════════════════════╣
     ║                                                                            ║
     ║  Handle:    DarkAngel                                                      ║
     ║  Real Name: Chris                                                          ║
     ║  Location:  Newark, DE                                                     ║
     ║  Member:    January 26, 2026                                               ║
     ║  Last On:   January 26, 2026 at 4:15 PM                                   ║
     ║                                                                            ║
     ╠══════════════════════════════════════════════════════════════════════════════╣
     ║  STATISTICS                                                                ║
     ╠══════════════════════════════════════════════════════════════════════════════╣
     ║                                                                            ║
     ║  Total Calls:    47          Messages Sent:  23                            ║
     ║  Time Online:    5h 32m      Games Played:   12                            ║
     ║                                                                            ║
     ╠══════════════════════════════════════════════════════════════════════════════╣
     ║  SIGNATURE                                                                 ║
     ╠══════════════════════════════════════════════════════════════════════════════╣
     ║  [user's ANSI signature, up to 3 lines]                                   ║
     ╚══════════════════════════════════════════════════════════════════════════════╝
     ```

     Colors:
     - Double-line border: LightCyan
     - Section headers (USER PROFILE, STATISTICS, SIGNATURE): Yellow, bold
     - Field labels (Handle, Real Name, etc.): LightGray
     - Field values: White, bold
     - User level badge [Sysop] or [User]: LightMagenta for Sysop, LightGreen for User
     - Signature: rendered as-is (may contain ANSI color codes)

     Handle optional fields gracefully: if real_name is None, show "(not set)". If location is None, show "(not set)". If signature is None/empty, show "(none)" in the signature section.

     Format time_online: convert total_time_minutes to "Xh Ym" format. If 0, show "0m".
     Format dates: parse ISO datetime strings and display as "Month Day, Year" or "Month Day, Year at H:MM AM/PM".

   - `pub fn render_profile_edit_menu(writer: &mut AnsiWriter)`:
     Shows editable fields for the user's own profile:
     ```
     Edit Profile:
       [1] Real Name    [2] Location
       [3] Signature    [4] Bio
       [Q] Return to menu
     ```
     This is prep for a profile edit flow. For this plan, just render the menu. Actual editing is a later concern (not in Phase 2 scope -- profile viewing is the requirement).

2. Add `pub fn format_duration_minutes(minutes: i64) -> String` helper to profile.rs:
   - 0 -> "0m"
   - 45 -> "45m"
   - 90 -> "1h 30m"
   - 1440 -> "24h 0m"

3. Add to `backend/src/db/user.rs` if not already present:
   - `pub async fn get_user_stats(pool: &SqlitePool, user_id: i64) -> Result<Option<User>, sqlx::Error>` -- May just be find_user_by_id, but ensure all stats fields are populated.

4. Update `backend/src/services/mod.rs` to add `pub mod profile;`
  </action>
  <verify>
Run `cd C:/Git/bbs/backend && cargo check` -- profile module compiles. `cargo test` -- test format_duration_minutes with various inputs: 0, 45, 90, 1440, etc.
  </verify>
  <done>Profile card renders as ANSI art with box-drawing, showing all user fields and stats. Duration formatting works. Optional fields handled gracefully.</done>
</task>

<task type="auto">
  <name>Task 2: Goodbye sequence with session stats</name>
  <files>
    backend/src/services/goodbye.rs
    backend/src/services/mod.rs
    backend/src/websocket/session.rs
    backend/src/db/user.rs
  </files>
  <action>
1. Create `backend/src/services/goodbye.rs`:

   - `pub fn render_goodbye(handle: &str, session_minutes: i64, total_calls: i64, total_time_minutes: i64) -> String`:
     Renders the goodbye screen using AnsiWriter:
     ```
     ╔══════════════════════════════════════════════════════════════════════════════╗
     ║                                                                            ║
     ║              Thanks for calling, DarkAngel!                                ║
     ║                                                                            ║
     ╠══════════════════════════════════════════════════════════════════════════════╣
     ║                                                                            ║
     ║   Session Time:   12 minutes                                               ║
     ║   Total Calls:    48                                                       ║
     ║   Total Time:     5h 44m                                                   ║
     ║                                                                            ║
     ╠══════════════════════════════════════════════════════════════════════════════╣
     ║                                                                            ║
     ║          Call again soon! The Construct awaits...                           ║
     ║                                                                            ║
     ║                      ── NO CARRIER ──                                              ║
     ║                                                                            ║
     ╚══════════════════════════════════════════════════════════════════════════════╝
     ```

     Colors:
     - Double-line border: LightCyan
     - Handle in farewell: Yellow, bold
     - Session stats labels: LightGray
     - Session stats values: White, bold
     - "Call again soon" message: LightGreen
     - "NO CARRIER" text: LightRed, bold (classic modem disconnect indicator)

   - Use format_duration_minutes from profile.rs for time formatting.

2. Update `backend/src/services/mod.rs` to add `pub mod goodbye;`

3. Update `backend/src/websocket/session.rs`:

   **Modify the quit/disconnect flow:**

   Currently when user types "quit" at main menu, the session shows a simple "Disconnecting..." message. Replace with the full goodbye sequence:

   - In handle_input() where it handles "quit"/"q" at main menu:
     a. Calculate session_minutes from login_time (stored in AuthState::Authenticated): `login_time.elapsed().as_secs() / 60`
     b. Fetch user from DB for current stats (total_calls, total_time_minutes)
     c. Update user's total_time_minutes by adding session_minutes: call update_user_time(pool, user_id, session_minutes as i64)
     d. Delete the session token: delete_session(pool, token)
     e. Clear localStorage token by sending `{"type":"logout"}` JSON message to frontend
     f. Render and send goodbye screen using render_goodbye()
     g. Sleep 3 seconds (let user read the goodbye screen)
     h. Then close the connection (existing behavior)

   **Modify on_disconnect() for unclean disconnects:**
   - If auth_state is Authenticated, also update session time and release node
   - Calculate elapsed session time, call update_user_time()
   - Release node via node_manager.release_node()
   - Don't show goodbye screen (user already disconnected)

   **Add logout JSON handling in frontend:**
   - The frontend websocket.ts already handles JSON messages (from Plan 05). Add: if type === "logout", call `localStorage.removeItem('bbs_session_token')`
  </action>
  <verify>
Run `cd C:/Git/bbs/backend && cargo check` -- goodbye module compiles, session integrates goodbye flow. `cargo test` passes.
  </verify>
  <done>Goodbye screen shows session stats (time online, total calls, total time) with ANSI art. Session time tracked and persisted to DB on logout. Clean disconnect shows goodbye, unclean disconnect still saves stats. Frontend clears token on logout.</done>
</task>

</tasks>

<verification>
1. `cargo check` and `cargo test` pass
2. Profile card renders correctly with all fields, handles missing optional fields
3. Goodbye screen shows current session time, total calls, total time
4. Session time updates in DB after logout
5. "NO CARRIER" message provides authentic modem disconnect feel
6. Frontend clears session token on explicit logout
</verification>

<success_criteria>
- Profile card displays: handle, real name, location, join date, last login, total calls, time online, messages sent, games played, signature
- Profile uses box-drawing ANSI art with CGA colors
- Goodbye screen shows: session time, total calls, total time, farewell message, NO CARRIER
- Session time tracked from login to logout (both clean and unclean disconnect)
- total_time_minutes updated in users table
- Frontend clears localStorage token on explicit logout
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-connection/02-06-SUMMARY.md`
</output>
