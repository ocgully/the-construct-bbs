//! VGA 256-color palette handling
//!
//! VGA uses 6-bit color values (0-63) which need to be converted to 8-bit (0-255).

/// Standard VGA 256-color palette (6-bit RGB values)
/// Each entry is (R, G, B) in 6-bit format (0-63)
#[rustfmt::skip]
pub const VGA_PALETTE: [(u8, u8, u8); 256] = [
    // 0x00-0x0F: Standard 16 colors
    (0, 0, 0),       // 0: Black
    (0, 0, 42),      // 1: Blue
    (0, 42, 0),      // 2: Green
    (0, 42, 42),     // 3: Cyan
    (42, 0, 0),      // 4: Red
    (42, 0, 42),     // 5: Magenta
    (42, 21, 0),     // 6: Brown
    (42, 42, 42),    // 7: Light Gray
    (21, 21, 21),    // 8: Dark Gray
    (21, 21, 63),    // 9: Light Blue
    (21, 63, 21),    // 10: Light Green
    (21, 63, 63),    // 11: Light Cyan
    (63, 21, 21),    // 12: Light Red
    (63, 21, 63),    // 13: Light Magenta
    (63, 63, 21),    // 14: Yellow
    (63, 63, 63),    // 15: White
    // 0x10-0x1F: Grayscale
    (0, 0, 0),       // 16
    (5, 5, 5),       // 17
    (8, 8, 8),       // 18
    (11, 11, 11),    // 19
    (14, 14, 14),    // 20
    (17, 17, 17),    // 21
    (20, 20, 20),    // 22
    (24, 24, 24),    // 23
    (28, 28, 28),    // 24
    (32, 32, 32),    // 25
    (36, 36, 36),    // 26
    (40, 40, 40),    // 27
    (45, 45, 45),    // 28
    (50, 50, 50),    // 29
    (56, 56, 56),    // 30
    (63, 63, 63),    // 31
    // 0x20-0x27: Blues
    (0, 0, 63),      // 32
    (16, 0, 63),     // 33
    (31, 0, 63),     // 34
    (47, 0, 63),     // 35
    (63, 0, 63),     // 36
    (63, 0, 47),     // 37
    (63, 0, 31),     // 38
    (63, 0, 16),     // 39
    // 0x28-0x2F: Reds
    (63, 0, 0),      // 40
    (63, 16, 0),     // 41
    (63, 31, 0),     // 42
    (63, 47, 0),     // 43
    (63, 63, 0),     // 44
    (47, 63, 0),     // 45
    (31, 63, 0),     // 46
    (16, 63, 0),     // 47
    // 0x30-0x37: Greens
    (0, 63, 0),      // 48
    (0, 63, 16),     // 49
    (0, 63, 31),     // 50
    (0, 63, 47),     // 51
    (0, 63, 63),     // 52
    (0, 47, 63),     // 53
    (0, 31, 63),     // 54
    (0, 16, 63),     // 55
    // 0x38-0x3F: Light colors
    (31, 31, 63),    // 56
    (39, 31, 63),    // 57
    (47, 31, 63),    // 58
    (55, 31, 63),    // 59
    (63, 31, 63),    // 60
    (63, 31, 55),    // 61
    (63, 31, 47),    // 62
    (63, 31, 39),    // 63
    // 0x40-0x47
    (63, 31, 31),    // 64
    (63, 39, 31),    // 65
    (63, 47, 31),    // 66
    (63, 55, 31),    // 67
    (63, 63, 31),    // 68
    (55, 63, 31),    // 69
    (47, 63, 31),    // 70
    (39, 63, 31),    // 71
    // 0x48-0x4F
    (31, 63, 31),    // 72
    (31, 63, 39),    // 73
    (31, 63, 47),    // 74
    (31, 63, 55),    // 75
    (31, 63, 63),    // 76
    (31, 55, 63),    // 77
    (31, 47, 63),    // 78
    (31, 39, 63),    // 79
    // 0x50-0x57
    (45, 45, 63),    // 80
    (49, 45, 63),    // 81
    (54, 45, 63),    // 82
    (58, 45, 63),    // 83
    (63, 45, 63),    // 84
    (63, 45, 58),    // 85
    (63, 45, 54),    // 86
    (63, 45, 49),    // 87
    // 0x58-0x5F
    (63, 45, 45),    // 88
    (63, 49, 45),    // 89
    (63, 54, 45),    // 90
    (63, 58, 45),    // 91
    (63, 63, 45),    // 92
    (58, 63, 45),    // 93
    (54, 63, 45),    // 94
    (49, 63, 45),    // 95
    // 0x60-0x67
    (45, 63, 45),    // 96
    (45, 63, 49),    // 97
    (45, 63, 54),    // 98
    (45, 63, 58),    // 99
    (45, 63, 63),    // 100
    (45, 58, 63),    // 101
    (45, 54, 63),    // 102
    (45, 49, 63),    // 103
    // 0x68-0x6F
    (0, 0, 28),      // 104
    (7, 0, 28),      // 105
    (14, 0, 28),     // 106
    (21, 0, 28),     // 107
    (28, 0, 28),     // 108
    (28, 0, 21),     // 109
    (28, 0, 14),     // 110
    (28, 0, 7),      // 111
    // 0x70-0x77
    (28, 0, 0),      // 112
    (28, 7, 0),      // 113
    (28, 14, 0),     // 114
    (28, 21, 0),     // 115
    (28, 28, 0),     // 116
    (21, 28, 0),     // 117
    (14, 28, 0),     // 118
    (7, 28, 0),      // 119
    // 0x78-0x7F
    (0, 28, 0),      // 120
    (0, 28, 7),      // 121
    (0, 28, 14),     // 122
    (0, 28, 21),     // 123
    (0, 28, 28),     // 124
    (0, 21, 28),     // 125
    (0, 14, 28),     // 126
    (0, 7, 28),      // 127
    // 0x80-0x87
    (14, 14, 28),    // 128
    (17, 14, 28),    // 129
    (21, 14, 28),    // 130
    (24, 14, 28),    // 131
    (28, 14, 28),    // 132
    (28, 14, 24),    // 133
    (28, 14, 21),    // 134
    (28, 14, 17),    // 135
    // 0x88-0x8F
    (28, 14, 14),    // 136
    (28, 17, 14),    // 137
    (28, 21, 14),    // 138
    (28, 24, 14),    // 139
    (28, 28, 14),    // 140
    (24, 28, 14),    // 141
    (21, 28, 14),    // 142
    (17, 28, 14),    // 143
    // 0x90-0x97
    (14, 28, 14),    // 144
    (14, 28, 17),    // 145
    (14, 28, 21),    // 146
    (14, 28, 24),    // 147
    (14, 28, 28),    // 148
    (14, 24, 28),    // 149
    (14, 21, 28),    // 150
    (14, 17, 28),    // 151
    // 0x98-0x9F
    (20, 20, 28),    // 152
    (22, 20, 28),    // 153
    (24, 20, 28),    // 154
    (26, 20, 28),    // 155
    (28, 20, 28),    // 156
    (28, 20, 26),    // 157
    (28, 20, 24),    // 158
    (28, 20, 22),    // 159
    // 0xA0-0xA7
    (28, 20, 20),    // 160
    (28, 22, 20),    // 161
    (28, 24, 20),    // 162
    (28, 26, 20),    // 163
    (28, 28, 20),    // 164
    (26, 28, 20),    // 165
    (24, 28, 20),    // 166
    (22, 28, 20),    // 167
    // 0xA8-0xAF
    (20, 28, 20),    // 168
    (20, 28, 22),    // 169
    (20, 28, 24),    // 170
    (20, 28, 26),    // 171
    (20, 28, 28),    // 172
    (20, 26, 28),    // 173
    (20, 24, 28),    // 174
    (20, 22, 28),    // 175
    // 0xB0-0xB7
    (0, 0, 16),      // 176
    (4, 0, 16),      // 177
    (8, 0, 16),      // 178
    (12, 0, 16),     // 179
    (16, 0, 16),     // 180
    (16, 0, 12),     // 181
    (16, 0, 8),      // 182
    (16, 0, 4),      // 183
    // 0xB8-0xBF
    (16, 0, 0),      // 184
    (16, 4, 0),      // 185
    (16, 8, 0),      // 186
    (16, 12, 0),     // 187
    (16, 16, 0),     // 188
    (12, 16, 0),     // 189
    (8, 16, 0),      // 190
    (4, 16, 0),      // 191
    // 0xC0-0xC7
    (0, 16, 0),      // 192
    (0, 16, 4),      // 193
    (0, 16, 8),      // 194
    (0, 16, 12),     // 195
    (0, 16, 16),     // 196
    (0, 12, 16),     // 197
    (0, 8, 16),      // 198
    (0, 4, 16),      // 199
    // 0xC8-0xCF
    (8, 8, 16),      // 200
    (10, 8, 16),     // 201
    (12, 8, 16),     // 202
    (14, 8, 16),     // 203
    (16, 8, 16),     // 204
    (16, 8, 14),     // 205
    (16, 8, 12),     // 206
    (16, 8, 10),     // 207
    // 0xD0-0xD7
    (16, 8, 8),      // 208
    (16, 10, 8),     // 209
    (16, 12, 8),     // 210
    (16, 14, 8),     // 211
    (16, 16, 8),     // 212
    (14, 16, 8),     // 213
    (12, 16, 8),     // 214
    (10, 16, 8),     // 215
    // 0xD8-0xDF
    (8, 16, 8),      // 216
    (8, 16, 10),     // 217
    (8, 16, 12),     // 218
    (8, 16, 14),     // 219
    (8, 16, 16),     // 220
    (8, 14, 16),     // 221
    (8, 12, 16),     // 222
    (8, 10, 16),     // 223
    // 0xE0-0xE7
    (11, 11, 16),    // 224
    (12, 11, 16),    // 225
    (13, 11, 16),    // 226
    (15, 11, 16),    // 227
    (16, 11, 16),    // 228
    (16, 11, 15),    // 229
    (16, 11, 13),    // 230
    (16, 11, 12),    // 231
    // 0xE8-0xEF
    (16, 11, 11),    // 232
    (16, 12, 11),    // 233
    (16, 13, 11),    // 234
    (16, 15, 11),    // 235
    (16, 16, 11),    // 236
    (15, 16, 11),    // 237
    (13, 16, 11),    // 238
    (12, 16, 11),    // 239
    // 0xF0-0xF7
    (11, 16, 11),    // 240
    (11, 16, 12),    // 241
    (11, 16, 13),    // 242
    (11, 16, 15),    // 243
    (11, 16, 16),    // 244
    (11, 15, 16),    // 245
    (11, 13, 16),    // 246
    (11, 12, 16),    // 247
    // 0xF8-0xFF
    (0, 0, 0),       // 248
    (0, 0, 0),       // 249
    (0, 0, 0),       // 250
    (0, 0, 0),       // 251
    (0, 0, 0),       // 252
    (0, 0, 0),       // 253
    (0, 0, 0),       // 254
    (0, 0, 0),       // 255
];

/// Convert a 6-bit VGA color component to 8-bit
///
/// VGA uses 0-63 range, we need 0-255 range.
/// Formula: value_8bit = (value_6bit * 255) / 63
#[inline]
pub fn vga6_to_rgb8(value: u8) -> u8 {
    // Using the standard scaling formula
    // For perfect accuracy: (value * 255 + 31) / 63
    ((value as u16 * 255 + 31) / 63) as u8
}

/// Convert a VGA palette index to 8-bit RGB
///
/// Returns (R, G, B) in 8-bit format (0-255)
pub fn palette_to_rgb(index: u8) -> (u8, u8, u8) {
    let (r, g, b) = VGA_PALETTE[index as usize];
    (vga6_to_rgb8(r), vga6_to_rgb8(g), vga6_to_rgb8(b))
}

/// Convert a VGA palette index to 8-bit RGBA
///
/// Returns (R, G, B, A) in 8-bit format (0-255)
/// Alpha is always 255 (fully opaque)
pub fn palette_to_rgba(index: u8) -> (u8, u8, u8, u8) {
    let (r, g, b) = palette_to_rgb(index);
    (r, g, b, 255)
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_vga6_to_rgb8_bounds() {
        // 0 should map to 0
        assert_eq!(vga6_to_rgb8(0), 0);
        // 63 should map to 255
        assert_eq!(vga6_to_rgb8(63), 255);
    }

    #[test]
    fn test_vga6_to_rgb8_midpoint() {
        // 31/32 should be around 127/128
        let mid_low = vga6_to_rgb8(31);
        let mid_high = vga6_to_rgb8(32);
        assert!(mid_low >= 125 && mid_low <= 130);
        assert!(mid_high >= 128 && mid_high <= 133);
    }

    #[test]
    fn test_palette_to_rgb_black() {
        // Index 0 is black
        let (r, g, b) = palette_to_rgb(0);
        assert_eq!((r, g, b), (0, 0, 0));
    }

    #[test]
    fn test_palette_to_rgb_white() {
        // Index 15 is white (63, 63, 63)
        let (r, g, b) = palette_to_rgb(15);
        assert_eq!((r, g, b), (255, 255, 255));
    }

    #[test]
    fn test_palette_to_rgba_alpha() {
        // All colors should have full alpha
        let (_, _, _, a) = palette_to_rgba(0);
        assert_eq!(a, 255);
        let (_, _, _, a) = palette_to_rgba(128);
        assert_eq!(a, 255);
    }

    #[test]
    fn test_palette_colors() {
        // Green (index 2) should be (0, 42, 0) -> (0, 170, 0) approximately
        let (r, g, b) = palette_to_rgb(2);
        assert_eq!(r, 0);
        assert!(g > 165 && g < 175); // Should be around 170
        assert_eq!(b, 0);
    }
}
